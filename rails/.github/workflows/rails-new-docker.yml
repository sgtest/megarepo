name: rails-new-docker

on: [push, pull_request]

env:
  APP_NAME: devrails
  APP_PATH: dev/devrails
  BUNDLE_WITHOUT: db:job:cable:storage:ujs

jobs:
  rails-new-docker:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
    - name: Generate --dev app
      run: |
        bundle exec railties/exe/rails new $APP_PATH --dev
    - name: Build image
      run: |
        podman build -t $APP_NAME \
        -v $(pwd):$(pwd) \
        -f ./$APP_PATH/Dockerfile \
        ./$APP_PATH
    - name: Run container
      run: |
        podman run --name $APP_NAME \
        -v $(pwd):$(pwd) \
        -e SECRET_KEY_BASE_DUMMY=1 \
        -p 3000:3000 $APP_NAME &
    - name: Test container
      run: ruby -r ./.github/workflows/scripts/test-container.rb

    - uses: zzak/action-discord@v4
      continue-on-error: true
      if: always() && github.ref_name == 'main'
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
