// NOTE: Assertions have been autogenerated by utils/generate-test-checks.py
// RUN: hlo-opt %s --platform=gpu --stage=llvm-before-optimizations --xla_gpu_target_config_filename=%S/../../../tools/hlo_opt/gpu_specs/%{GPU}.txtpb --split-input-file | FileCheck --check-prefixes=CHECK,CHECK-%{PTX} %s

HloModule Transpose, is_scheduled=true

%fused_computation {
  %p0 = f32[33,49,65] parameter(0)
  %neg = f32[33,49,65] negate(%p0)
  %transpose = f32[65,49,33] transpose(%p0), dimensions={2,1,0}
  ROOT %tuple = (f32[33,49,65], f32[65,49,33]) tuple(%neg, %transpose)
}

ENTRY main {
  %param = f32[33,49,65]{2,1,0} parameter(0)
  ROOT %fusion = (f32[33,49,65], f32[65,49,33]) fusion(%param), kind=kInput, calls=%fused_computation
}

// CHECK-LABEL: entry:
// CHECK:         %[[VAL_0:.*]] = alloca i32, align 4
// CHECK:         %[[VAL_1:.*]] = alloca i32, align 4
// CHECK:         %[[VAL_2:.*]] = alloca i32, align 4
// CHECK:         %[[VAL_3:.*]] = alloca i32, align 4
// CHECK-PTX:     %[[VAL_4:.*]] = call i32 @llvm.nvvm.read.ptx.sreg.tid.x(), !range !2
// CHECK-GCN:     %[[VAL_4:.*]] = call i32 @llvm.amdgcn.workitem.id.x
// CHECK-PTX:     %[[VAL_5:.*]] = call i32 @llvm.nvvm.read.ptx.sreg.ctaid.x(), !range !3
// CHECK-GCN:     %[[VAL_5:.*]] = call i32 @llvm.amdgcn.workgroup.id.x
// CHECK:         %[[VAL_7:.*]] = udiv i32 %[[VAL_4]], 128
// CHECK:         %[[VAL_6:.*]] = urem i32 %[[VAL_4]], 128
// CHECK:         %[[VAL_15:.*]] = udiv i32 %[[VAL_6]], 32
// CHECK:         %[[VAL_14:.*]] = urem i32 %[[VAL_4]], 32
// CHECK:         %[[VAL_37:.*]] = mul i32 %[[VAL_14]], 1
// CHECK:         %[[VAL_16:.*]] = urem i32 %[[VAL_4]], 32
// CHECK:         %[[VAL_17:.*]] = udiv i32 %[[VAL_5]], 1
// CHECK:         %[[VAL_18:.*]] = urem i32 %[[VAL_17]], 3
// CHECK:         %[[VAL_19:.*]] = udiv i32 %[[VAL_5]], 3
// CHECK:         %[[VAL_20:.*]] = urem i32 %[[VAL_19]], 2
// CHECK:         %[[VAL_21:.*]] = udiv i32 %[[VAL_5]], 6
// CHECK:         %[[VAL_22:.*]] = icmp eq i32 %[[VAL_20]], 1
// CHECK:         %[[VAL_23:.*]] = select i1 %[[VAL_22]], i32 1, i32 32
// CHECK:         %[[VAL_24:.*]] = icmp eq i32 %[[VAL_18]], 2
// CHECK:         %[[VAL_25:.*]] = select i1 %[[VAL_24]], i32 1, i32 32
// CHECK:         %[[VAL_26:.*]] = mul i32 %[[VAL_21]], 1
// CHECK:         %[[VAL_27:.*]] = mul i32 %[[VAL_20]], 32
// CHECK:         %[[VAL_28:.*]] = mul i32 %[[VAL_18]], 32
// CHECK:         store i32 %[[VAL_15]], ptr %[[VAL_3]], align 4
// CHECK:         br label %[[VAL_29:.*]]
// CHECK:       loop1.loop_header:                            ; preds = %[[VAL_30:.*]], %entry
// CHECK:         %[[VAL_31:.*]] = load i32, ptr %[[VAL_3]], align 4
// CHECK:         %[[VAL_32:.*]] = icmp uge i32 %[[VAL_31]], %[[VAL_23]]
// CHECK:         br i1 %[[VAL_32]], label %[[VAL_33:.*]], label %[[VAL_34:.*]]
// CHECK:       loop1.loop_body:                              ; preds = %[[VAL_29]]
// CHECK:         %[[VAL_35:.*]] = add nuw nsw i32 %[[VAL_31]], 4
// CHECK:         store i32 %[[VAL_35]], ptr %[[VAL_3]], align 4
// CHECK:         %[[VAL_36:.*]] = icmp eq i32 %[[VAL_31]], %[[VAL_15]]
// CHECK:         store i32 0, ptr %[[VAL_2]], align 4
// CHECK:         br label %[[VAL_38:.*]]
// CHECK:       loop2.loop_header:                            ; preds = %[[VAL_39:.*]], %[[VAL_34]]
// CHECK:         %[[VAL_40:.*]] = load i32, ptr %[[VAL_2]], align 4
// CHECK:         %[[VAL_41:.*]] = icmp uge i32 %[[VAL_40]], 1
// CHECK:         br i1 %[[VAL_41]], label %[[VAL_30]], label %[[VAL_42:.*]]
// CHECK:       loop2.loop_body:                              ; preds = %[[VAL_38]]
// CHECK:         %[[VAL_43:.*]] = add nuw nsw i32 %[[VAL_40]], 1
// CHECK:         store i32 %[[VAL_43]], ptr %[[VAL_2]], align 4
// CHECK:         %[[VAL_44:.*]] = icmp eq i32 %[[VAL_40]], 0
// CHECK:         %[[VAL_45:.*]] = mul i32 %[[VAL_40]], 32
// CHECK:         %[[VAL_46:.*]] = add i32 %[[VAL_45]], 0
// CHECK:         %[[VAL_47:.*]] = add i32 %[[VAL_46]], %[[VAL_37]]
// CHECK:         %[[VAL_48:.*]] = icmp ult i32 %[[VAL_47]], %[[VAL_25]]
// CHECK:         br i1 %[[VAL_48]], label %[[VAL_49:.*]], label %[[VAL_39]]
// CHECK:       x_in_tile-after:                                  ; preds = %[[VAL_49]], %[[VAL_42]]
// CHECK:         br label %[[VAL_38]], !llvm.loop !4
// CHECK:       loop2.loop_exit:                              ; preds = %[[VAL_38]]
// CHECK:         br label %[[VAL_29]], !llvm.loop !7
// CHECK:       loop1.loop_exit:                              ; preds = %[[VAL_29]]
// CHECK:         call void @llvm.nvvm.barrier0()
// CHECK:         store i32 %[[VAL_15]], ptr %[[VAL_1]], align 4
// CHECK:         br label %[[VAL_50:.*]]
// CHECK:       loop1.loop_header7:                           ; preds = %[[VAL_51:.*]], %[[VAL_33]]
// CHECK:         %[[VAL_52:.*]] = load i32, ptr %[[VAL_1]], align 4
// CHECK:         %[[VAL_53:.*]] = icmp uge i32 %[[VAL_52]], %[[VAL_25]]
// CHECK:         br i1 %[[VAL_53]], label %[[VAL_54:.*]], label %[[VAL_55:.*]]
// CHECK:       loop1.loop_body8:                             ; preds = %[[VAL_50]]
// CHECK:         %[[VAL_56:.*]] = add nuw nsw i32 %[[VAL_52]], 4
// CHECK:         store i32 %[[VAL_56]], ptr %[[VAL_1]], align 4
// CHECK:         %[[VAL_57:.*]] = icmp eq i32 %[[VAL_52]], %[[VAL_15]]
// CHECK:         store i32 0, ptr %[[VAL_0]], align 4
// CHECK:         br label %[[VAL_59:.*]]
// CHECK:       loop2.loop_header13:                          ; preds = %[[VAL_60:.*]], %[[VAL_55]]
// CHECK:         %[[VAL_61:.*]] = load i32, ptr %[[VAL_0]], align 4
// CHECK:         %[[VAL_62:.*]] = icmp uge i32 %[[VAL_61]], 1
// CHECK:         br i1 %[[VAL_62]], label %[[VAL_51]], label %[[VAL_63:.*]]
// CHECK:       loop2.loop_body14:                            ; preds = %[[VAL_59]]
// CHECK:         %[[VAL_64:.*]] = add nuw nsw i32 %[[VAL_61]], 1
// CHECK:         store i32 %[[VAL_64]], ptr %[[VAL_0]], align 4
// CHECK:         %[[VAL_65:.*]] = icmp eq i32 %[[VAL_61]], 0
// CHECK:         %[[VAL_66:.*]] = mul i32 %[[VAL_61]], 32
// CHECK:         %[[VAL_67:.*]] = add i32 %[[VAL_66]], 0
// CHECK:         %[[VAL_68:.*]] = add i32 %[[VAL_67]], %[[VAL_37]]
// CHECK:         %[[VAL_69:.*]] = icmp ult i32 %[[VAL_68]], %[[VAL_23]]
// CHECK:         br i1 %[[VAL_69]], label %[[VAL_70:.*]], label %[[VAL_60]]
// CHECK:       x_in_tile-after19:                                ; preds = %[[VAL_70]], %[[VAL_63]]
// CHECK:         br label %[[VAL_59]], !llvm.loop !8
// CHECK:       loop2.loop_exit12:                            ; preds = %[[VAL_59]]
// CHECK:         br label %[[VAL_50]], !llvm.loop !9
// CHECK:       loop1.loop_exit6:                             ; preds = %[[VAL_50]]
// CHECK:         ret void
// CHECK:       x_in_tile-true:                                   ; preds = %[[VAL_42]]
// CHECK:         %[[TILE_1:.*]] = add i32 %[[VAL_26]], 0
// CHECK:         %[[VAL_71:.*]] = add i32 %[[VAL_27]], %[[VAL_31]]
// CHECK:         %[[VAL_72:.*]] = add i32 %[[VAL_28]], %[[VAL_47]]
// CHECK:         %[[VAL_73:.*]] = getelementptr inbounds [33 x [49 x [65 x float]]], ptr %[[VAL_74:.*]], i32 0, i32 %[[VAL_71]], i32 %[[TILE_1]], i32 %[[VAL_72]]
// CHECK:         %[[VAL_75:.*]] = load float, ptr %[[VAL_73]], align 4, !invariant.load !10
// CHECK:         %[[VAL_76:.*]] = getelementptr inbounds [1 x [32 x [33 x float]]], ptr addrspace(3) @tr_tile_0, i32 0, i32 0, i32 %[[VAL_31]], i32 %[[VAL_47]]
// CHECK:         %[[VAL_77:.*]] = addrspacecast ptr addrspace(3) %[[VAL_76]] to ptr
// CHECK:         store float %[[VAL_75]], ptr %[[VAL_77]], align 4
// CHECK:         %[[VAL_78:.*]] = getelementptr inbounds [33 x [49 x [65 x float]]], ptr %[[VAL_74]], i32 0, i32 %[[VAL_71]], i32 %[[TILE_1]], i32 %[[VAL_72]]
// CHECK:         %[[VAL_79:.*]] = load float, ptr %[[VAL_78]], align 4, !invariant.load !10
// CHECK:         %[[VAL_80:.*]] = fneg float %[[VAL_79]]
// CHECK:         %[[VAL_81:.*]] = getelementptr inbounds [33 x [49 x [65 x float]]], ptr %[[VAL_82:.*]], i32 0, i32 %[[VAL_71]], i32 %[[TILE_1]], i32 %[[VAL_72]]
// CHECK:         store float %[[VAL_80]], ptr %[[VAL_81]], align 4
// CHECK:         br label %[[VAL_39]]
// CHECK:       x_in_tile-true18:                                 ; preds = %[[VAL_63]]
// CHECK:         %[[TILE_1:.*]] = add i32 %[[VAL_26]], 0
// CHECK:         %[[VAL_83:.*]] = add i32 %[[VAL_28]], %[[VAL_52]]
// CHECK:         %[[VAL_84:.*]] = add i32 %[[VAL_27]], %[[VAL_68]]
// CHECK:         %[[VAL_85:.*]] = getelementptr inbounds [1 x [32 x [33 x float]]], ptr addrspace(3) @tr_tile_0, i32 0, i32 0, i32 %[[VAL_68]], i32 %[[VAL_52]]
// CHECK:         %[[VAL_86:.*]] = addrspacecast ptr addrspace(3) %[[VAL_85]] to ptr
// CHECK:         %[[VAL_87:.*]] = load float, ptr %[[VAL_86]], align 4
// CHECK:         %[[VAL_88:.*]] = getelementptr inbounds [65 x [49 x [33 x float]]], ptr %[[VAL_89:.*]], i32 0, i32 %[[VAL_83]], i32 %[[TILE_1]], i32 %[[VAL_84]]
// CHECK:         store float %[[VAL_87]], ptr %[[VAL_88]], align 4
// CHECK:         br label %[[VAL_60]]
