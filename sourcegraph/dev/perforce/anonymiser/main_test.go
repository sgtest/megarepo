package main

import (
	"bytes"
	"os"
	"testing"

	"github.com/hexops/autogold/v2"
)

func TestAnonymiser(t *testing.T) {
	input, err := os.Open("testdata/sample-protects.txt")
	if err != nil {
		t.Fatal(err)
	}
	t.Cleanup(func() {
		if err := input.Close(); err != nil {
			t.Fatal(err)
		}
	})

	var output bytes.Buffer
	if err := anonymiseProtection(input, &output); err != nil {
		t.Fatal(err)
	}

	want := autogold.Expect(`
Update: 2021/03/26 18:56:46

Protections:
 list group * //ba0465/efa1f3
 list group 5d6799 * -//...
 read group 8171ba * //...
 write group ef260e * //ba0465/0d6e40/...
 open group ef260e * //ba0465/0d6e40/8a6cea/...
 write group ef260e * //ba0465/c2fb78/...
 write group ef260e * //ba0465/9f86d0/...
 read group 3e4664 * //ba0465/21900f/...
 read group 3e4664 * //ba0465/02c000/...
 write group ef260e * //ba0465/21900f/...
 write group ef260e * //ba0465/02c000/...
 read user 61ea08 * //ba0465/61ea08/35bafb/...
 read group 3e4664 * //ba0465/0d6e40/cae662/...
 write group 065db1 * //ba0465/0d6e40/cae662/...
 write group 065db1 * //ba0465/e7f6c0*/*/cae662/...
 =write group 5d6799 * -//ba0465/.../cae662/7bdc25/c4c5b4/...
 =write group 5d6799 * -//ba0465/.../cae662/7bdc25/9137aa/...
 =write group 5d6799 * -//ba0465/.../cae662/7bdc25/e4b530/c4c5b4/...
 =write group 5d6799 * -//ba0465/.../cae662/2c26b4/b79606/227464
 =write group 5d6799 * -//ba0465/.../cae662/7bdc25/4ec7c5/...
 =write group 5d6799 * -//ba0465/0d6e40/cae662/14c252/38a096/e55cff/...
 =write group 5d6799 * -//ba0465/0d6e40/cae662/df0ad6/d0cc7e/...
 =write group 5d6799 * -//ba0465/0d6e40/cae662/24ea04/38a096/6eeb55/fcde2b/2947d7
 =write group 5d6799 * -//ba0465/0d6e40/cae662/24ea04/38a096/6eeb55/fcde2b/479b6e
 =write group 5d6799 * -//ba0465/0d6e40/cae662/24ea04/38a096/6eeb55/fcde2b/b0b249
 =write group 5d6799 * -//ba0465/0d6e40/cae662/652f55/38a096/e55cff/...
 =write group 5d6799 * -//ba0465/0d6e40/cae662/2c26b4/1509e1/cae662/b50fcb
 =write group 5d6799 * -//ba0465/0d6e40/cae662/2c26b4/1509e1/cae662/9fd1f2
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/14c252/38a096/e55cff/...
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/df0ad6/d0cc7e/...
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/24ea04/38a096/6eeb55/fcde2b/2947d7
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/24ea04/38a096/6eeb55/fcde2b/8ab83a
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/24ea04/38a096/6eeb55/fcde2b/511b46
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/652f55/38a096/e55cff/...
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/2c26b4/1509e1/cae662/b50fcb
 =write group 5d6799 * -//ba0465/e7f6c0*/*/cae662/2c26b4/1509e1/cae662/9fd1f2
 write group 1102fb * //ba0465/0d6e40/cae662/14c252/38a096/e55cff/...
 write group 1102fb * //ba0465/0d6e40/cae662/df0ad6/d0cc7e/...
 write group 1102fb * //ba0465/0d6e40/cae662/24ea04/38a096/6eeb55/fcde2b/2947d7
 write group 1102fb * //ba0465/0d6e40/cae662/24ea04/38a096/6eeb55/fcde2b/8ab83a
 write group 1102fb * //ba0465/0d6e40/cae662/24ea04/38a096/6eeb55/fcde2b/511b46
 write group 1102fb * //ba0465/0d6e40/cae662/652f55/38a096/e55cff/...
 write group 1102fb * //ba0465/0d6e40/cae662/2c26b4/1509e1/cae662/b50fcb
 write group 1102fb * //ba0465/0d6e40/cae662/2c26b4/1509e1/cae662/9fd1f2
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/14c252/38a096/e55cff/...
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/df0ad6/d0cc7e/...
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/24ea04/38a096/6eeb55/fcde2b/2947d7
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/24ea04/38a096/6eeb55/fcde2b/8ab83a
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/24ea04/38a096/6eeb55/fcde2b/511b46
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/652f55/38a096/e55cff/...
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/2c26b4/1509e1/cae662/b50fcb
 write group 1102fb * //ba0465/e7f6c0*/*/cae662/2c26b4/1509e1/cae662/9fd1f2
 write group 21eb4f * //ba0465/0d6e40/cae662/7bdc25/c4c5b4/...
 write group 21eb4f * //ba0465/e7f6c0*/*/cae662/7bdc25/c4c5b4/...
 write group 6e02ee * //ba0465/0d6e40/cae662/7bdc25/9137aa/...
 write group 6e02ee * //ba0465/.../.../cae662/7bdc25/9137aa/...
 write group 6e02ee * //ba0465/0d6e40/cae662/7bdc25/e4b530/c4c5b4/...
 write group 6e02ee * //ba0465/.../.../cae662/7bdc25/e4b530/c4c5b4/...
 write group 6e02ee * //ba0465/0d6e40/cae662/2c26b4/b79606/227464
 write group 6e02ee * //ba0465/.../.../cae662/2c26b4/b79606/227464
 write group 6e02ee * //ba0465/0d6e40/cae662/7bdc25/4ec7c5/...
 write group 6e02ee * //ba0465/.../.../cae662/7bdc25/4ec7c5/...
 read group 1ff59d * -//ba0465/...
 =write group 48ff27 * -//ba0465/...
 write group f2ceee * //ba0465/0d6e40/cae662/7fe067/...
 write group f2ceee * //ba0465/e7f6c0*/a4895e/cae662/7fe067/...
 write group f2a83f * //ba0465/0d6e40/cae662/2c26b4/...
 write group f2a83f * //ba0465/0d6e40/cae662/268f27/...
 write group f2a83f * //ba0465/.../.../cae662/2c26b4/...
 write group f2a83f * //ba0465/.../.../cae662/268f27/...
 write group 4c6871 * //ba0465/.../.../cae662/2c26b4/b79606/d772eb/...
 write group 4c6871 * //ba0465/.../.../cae662/cdb8ed/...
 write group 4c6871 * //ba0465/.../.../cae662/268f27/9f86d0/...
 write group 4c6871 * //ba0465/.../cae662/2c26b4/b79606/d772eb/...
 write group 4c6871 * //ba0465/.../cae662/cdb8ed/...
 write group 4c6871 * //ba0465/.../cae662/268f27/9f86d0/...
 write group 772503 * //ba0465/0d6e40/cae662/7bdc25/e4b530/...
 write group 772503 * //ba0465/e7f6c0*/*/cae662/7bdc25/e4b530/...
`)
	want.Equal(t, output.String())
}
