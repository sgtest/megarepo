import { type FC, type ReactNode, type ReactElement, useState } from 'react'

import { FilterLink, SearchSidebar, SearchSidebarSection, CodeHostIcon } from '@sourcegraph/branded'
import { displayRepoName } from '@sourcegraph/shared/src/components/RepoLink'
import { FilterType } from '@sourcegraph/shared/src/search/query/filters'
import { SectionID } from '@sourcegraph/shared/src/settings/temporary/searchSidebar'

import { ConnectionError, ConnectionLoading } from '../../../../components/FilteredConnection/ui'
import type { VulnerabilityMatchesCountByRepositoryFields } from '../../../../graphql-operations'
import { useVulnerabilityMatchesCountByRepoQuery } from '../../graphql/useVulnerabilityMatchesCountByRepoQuery'

import styles from './VulnerabilitySidebar.module.scss'

interface Filters {
    severity: string
    language: string
    repositoryName: string
}
export interface VulnerabilitySidebarProps {
    onShowMobileFiltersChanged: React.Dispatch<React.SetStateAction<boolean>>
    onFilterChosen: (filters: Filters) => void
}

export const VulnerabilitySidebarView: FC<VulnerabilitySidebarProps> = ({
    onShowMobileFiltersChanged,
    onFilterChosen,
}) => {
    const severity = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'ALL']
    const languages = ['go', 'typescript']
    const [repositoryName] = useState('')
    const { loading, connection, error } = useVulnerabilityMatchesCountByRepoQuery({ repositoryName })
    const filters = getFormattedRepositoryFilters(connection?.nodes)

    return (
        <SearchSidebar onClose={() => onShowMobileFiltersChanged(prev => !prev)} className={styles.sidebarContainer}>
            <SearchSidebarSection sectionId={SectionID.SEVERITY} header="Severity" minItems={5}>
                {severity.map(severity => (
                    <FilterLink
                        key={severity}
                        value={severity}
                        label={severity.toLowerCase()}
                        onFilterChosen={() =>
                            onFilterChosen({
                                severity: severity === 'ALL' ? '' : severity,
                                language: '',
                                repositoryName: '',
                            })
                        }
                    />
                ))}
            </SearchSidebarSection>

            <SearchSidebarSection sectionId={SectionID.LANGUAGES} header="Languages" minItems={2}>
                {languages.map(language => (
                    <FilterLink
                        key={language}
                        value={`lang:${language}`}
                        label={language}
                        onFilterChosen={() => onFilterChosen({ severity: '', language, repositoryName: '' })}
                    />
                ))}
            </SearchSidebarSection>

            {loading && !connection ? (
                <ConnectionLoading />
            ) : error ? (
                <ConnectionError errors={[error.message]} />
            ) : filters.length ? (
                <SearchSidebarSection
                    sectionId={SectionID.REPOSITORIES}
                    header="Repositories"
                    searchOptions={{
                        ariaLabel: 'Find repositories',
                        noResultText: getRepoFilterNoResultText,
                    }}
                    minItems={1}
                >
                    {getRepoFilterLinks(filters, repositoryName =>
                        onFilterChosen({ severity: '', language: '', repositoryName })
                    )}{' '}
                </SearchSidebarSection>
            ) : null}
        </SearchSidebar>
    )
}

const getRepoFilterNoResultText = (repoFilterLinks: ReactElement[]): ReactNode => (
    <span>None of the top {repoFilterLinks.length} repositories in your results match this filter.</span>
)

export const getRepoFilterLinks = (
    filters: RepositoryFilter[],
    onFilterChosen: (value: string, kind?: string) => void
): React.ReactElement[] => {
    function repoLabelConverter(label: string): JSX.Element {
        const Icon = CodeHostIcon({
            repoName: label,
            className: styles.sidebarSectionIcon,
        })

        return (
            <span className={styles.sidebarSectionListItemBreakWords}>
                {Icon ? (
                    <>
                        {Icon}
                        {displayRepoName(label)}
                    </>
                ) : (
                    label
                )}
            </span>
        )
    }

    return getFiltersOfKind(filters, FilterType.repo).map(filter => (
        <FilterLink
            {...filter}
            key={`${filter.label}-${filter.value}`}
            labelConverter={repoLabelConverter}
            onFilterChosen={onFilterChosen}
            ariaLabel={`Search in repository ${filter.label}`}
        />
    ))
}

interface RepositoryFilter {
    value: string
    label: string
    count: number
    limitHit: boolean
    kind: string
}
function getFormattedRepositoryFilters(
    connection: VulnerabilityMatchesCountByRepositoryFields[] | undefined
): RepositoryFilter[] {
    if (!connection) {
        return []
    }
    return connection.map(({ repositoryName, matchCount }) => ({
        value: repositoryName,
        label: repositoryName,
        count: matchCount,
        limitHit: false,
        kind: 'repo',
    }))
}

function getFiltersOfKind(filters: RepositoryFilter[] = [], kind: FilterType): RepositoryFilter[] {
    return filters.filter(filter => filter.kind === kind && filter.value !== '')
}
