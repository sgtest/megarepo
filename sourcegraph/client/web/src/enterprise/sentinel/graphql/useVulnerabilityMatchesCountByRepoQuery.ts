import { dataOrThrowErrors } from '@sourcegraph/http-client'

import {
    type UseShowMorePaginationResult,
    useShowMorePagination,
} from '../../../components/FilteredConnection/hooks/useShowMorePagination'
import type {
    VulnerabilityMatchesCountByRepositoryResult,
    VulnerabilityMatchesCountByRepositoryVariables,
    VulnerabilityMatchesCountByRepositoryFields,
} from '../../../graphql-operations'

import { VULNERABILITY_MATCHES_COUNT_BY_REPOSITORY } from './graphqlQueries'

interface UseVulnerabilityMatchesCountByRepoProps {
    repositoryName: string
}

export const useVulnerabilityMatchesCountByRepoQuery = ({
    repositoryName,
}: UseVulnerabilityMatchesCountByRepoProps): UseShowMorePaginationResult<
    VulnerabilityMatchesCountByRepositoryResult,
    VulnerabilityMatchesCountByRepositoryFields
> =>
    useShowMorePagination<
        VulnerabilityMatchesCountByRepositoryResult,
        VulnerabilityMatchesCountByRepositoryVariables,
        VulnerabilityMatchesCountByRepositoryFields
    >({
        query: VULNERABILITY_MATCHES_COUNT_BY_REPOSITORY,
        variables: { after: null, first: 50, repositoryName },
        options: { fetchPolicy: 'network-only' },
        getConnection: result => {
            const { vulnerabilityMatchesCountByRepository } = dataOrThrowErrors(result)
            return vulnerabilityMatchesCountByRepository
        },
    })
