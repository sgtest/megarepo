import React, { useCallback, useEffect } from 'react'

import { mdiClose } from '@mdi/js'
import classNames from 'classnames'

import { useTemporarySetting } from '@sourcegraph/shared/src/settings/temporary'
import { TelemetryProps } from '@sourcegraph/shared/src/telemetry/telemetryService'
import { Button, H4, Icon, Text } from '@sourcegraph/wildcard'

import { MarketingBlock } from '../../components/MarketingBlock'
import { EventName } from '../../util/constants'

import styles from './TryCodyWidget.module.scss'

const GlowingCodySVG: React.FC = () => (
    <svg width="129" height="120" viewBox="0 0 129 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_dd_35_36617)">
            <rect x="25.2822" y="22.9186" width="78.4355" height="74.1628" rx="6" fill="#E8D1FF" />
            <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M75.8031 39.0714C78.1652 39.0714 80.0801 40.9864 80.0801 43.3487L80.0801 53.1256C80.0801 55.488 78.1652 57.403 75.8031 57.403C73.441 57.403 71.5262 55.488 71.5262 53.1256L71.5262 43.3487C71.5262 40.9864 73.441 39.0713 75.8031 39.0714Z"
                fill="#A305E1"
            />
            <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M44.0312 50.0703C44.0312 47.708 45.9461 45.7929 48.3082 45.7929H58.0841C60.4462 45.7929 62.3611 47.708 62.3611 50.0703C62.3611 52.4327 60.4462 54.3477 58.0841 54.3477H48.3082C45.9461 54.3477 44.0312 52.4327 44.0312 50.0703Z"
                fill="#A112FF"
            />
            <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M48.9633 65.5066C47.5415 63.637 44.8751 63.263 42.9933 64.6746C41.1036 66.092 40.7206 68.7731 42.1379 70.6629L45.5594 68.0965C42.1379 70.6629 42.1391 70.6645 42.1403 70.6662L42.1429 70.6696L42.1485 70.6771L42.1616 70.6944C42.1712 70.7069 42.1825 70.7216 42.1954 70.7383C42.2212 70.7717 42.2537 70.8132 42.2929 70.8622C42.3712 70.9602 42.4763 71.0886 42.6082 71.243C42.8717 71.5514 43.2438 71.9653 43.7243 72.4487C44.6829 73.4132 46.0882 74.6697 47.9407 75.9197C51.659 78.4287 57.2127 80.9286 64.5002 80.9286C71.7878 80.9286 77.3414 78.4287 81.0598 75.9197C82.9123 74.6697 84.3175 73.4132 85.2762 72.4487C85.7567 71.9653 86.1288 71.5514 86.3923 71.243C86.5242 71.0886 86.6293 70.9602 86.7076 70.8622C86.7468 70.8132 86.7793 70.7717 86.8051 70.7383C86.818 70.7216 86.8293 70.7069 86.8388 70.6944L86.852 70.6771L86.8576 70.6696L86.8602 70.6662C86.8614 70.6645 86.8626 70.6629 83.4411 68.0965L86.8626 70.6629C88.2799 68.7731 87.8969 66.092 86.0072 64.6746C84.1254 63.2631 81.459 63.637 80.0372 65.5066C80.0348 65.5097 80.0305 65.5152 80.0243 65.5229C80.0025 65.5502 79.9575 65.6056 79.8895 65.6852C79.7533 65.8446 79.5263 66.0991 79.2097 66.4176C78.574 67.0572 77.5926 67.9394 76.2756 68.8281C73.6548 70.5965 69.7381 72.3739 64.5002 72.3739C59.2624 72.3739 55.3457 70.5965 52.7249 68.8281C51.4079 67.9394 50.4265 67.0572 49.7908 66.4176C49.4742 66.0991 49.2472 65.8446 49.111 65.6852C49.043 65.6056 48.998 65.5502 48.9762 65.5229C48.97 65.5152 48.9657 65.5097 48.9633 65.5066ZM80.0245 65.5234L80.0239 65.5242L80.0218 65.527C80.0207 65.5285 80.0195 65.53 83.3308 68.0138L80.0195 65.5301C80.0211 65.5278 80.0228 65.5256 80.0245 65.5234Z"
                fill="#A305E1"
            />
        </g>
        <defs>
            <filter
                id="filter0_dd_35_36617"
                x="11.2822"
                y="12.9186"
                width="106.436"
                height="102.163"
                filterUnits="userSpaceOnUse"
                colorInterpolationFilters="sRGB"
            >
                <feFlood floodOpacity="0" result="BackgroundImageFix" />
                <feColorMatrix
                    in="SourceAlpha"
                    type="matrix"
                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                    result="hardAlpha"
                />
                <feOffset dy="4" />
                <feGaussianBlur stdDeviation="3" />
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.05 0" />
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_35_36617" />
                <feColorMatrix
                    in="SourceAlpha"
                    type="matrix"
                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                    result="hardAlpha"
                />
                <feMorphology radius="3" operator="erode" in="SourceAlpha" result="effect2_dropShadow_35_36617" />
                <feOffset dy="4" />
                <feGaussianBlur stdDeviation="8.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 0.556863 0 0 0 0 0.207843 0 0 0 0 0.956863 0 0 0 0.42 0" />
                <feBlend mode="normal" in2="effect1_dropShadow_35_36617" result="effect2_dropShadow_35_36617" />
                <feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_35_36617" result="shape" />
            </filter>
        </defs>
    </svg>
)

const CodyPopupSVG: React.FC = () => (
    <svg width="530" height="63" viewBox="0 0 530 63" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_35_36627)">
            <rect x="10" y="9" width="507.25" height="39.407" rx="8.2035" fill="white" shapeRendering="crispEdges" />
            <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M37.2199 19.8167C38.3783 19.8167 39.3174 20.7715 39.3174 21.9494L39.3174 25.7408C39.3174 26.9186 38.3783 27.8735 37.2199 27.8735C36.0615 27.8735 35.1224 26.9186 35.1224 25.7408L35.1224 21.9494C35.1224 20.7715 36.0615 19.8167 37.2199 19.8167Z"
                fill="#A112FF"
            />
            <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M23.9365 24.7927C23.9365 23.6149 24.8756 22.66 26.034 22.66H29.7629C30.9213 22.66 31.8603 23.6149 31.8603 24.7927C31.8603 25.9706 30.9213 26.9254 29.7629 26.9254H26.034C24.8756 26.9254 23.9365 25.9706 23.9365 24.7927Z"
                fill="#A112FF"
            />
            <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M42.2331 31.0011C42.9797 31.7222 43.0099 32.9221 42.3007 33.6811L41.6408 34.3874C36.4767 39.9145 27.7706 39.7768 22.7781 34.0891C22.0925 33.308 22.1594 32.1096 22.9277 31.4125C23.6959 30.7153 24.8745 30.7834 25.5601 31.5645C29.1008 35.5982 35.2751 35.6958 38.9374 31.7761L39.5973 31.0698C40.3065 30.3107 41.4866 30.28 42.2331 31.0011Z"
                fill="#A112FF"
            />
            <rect x="53.0684" y="13.7854" width="120.261" height="29.8362" rx="7.51987" fill="white" />
            <path
                d="M74.2605 31.438H72.4375V29.615H74.2605V31.438ZM79.7295 31.438H76.0835V29.615H79.7295V31.438ZM70.6145 27.792H68.7915V25.969H70.6145V27.792ZM79.7295 27.792H72.4375V25.969H79.7295V27.792ZM81.5525 35.9955H66.9685C66.485 35.9955 66.0213 35.8034 65.6795 35.4616C65.3376 35.1197 65.1455 34.656 65.1455 34.1725V23.2345C65.1455 22.751 65.3376 22.2873 65.6795 21.9454C66.0213 21.6036 66.485 21.4115 66.9685 21.4115H81.5525C82.036 21.4115 82.4997 21.6036 82.8416 21.9454C83.1834 22.2873 83.3755 22.751 83.3755 23.2345V34.1725C83.3755 34.656 83.1834 35.1197 82.8416 35.4616C82.4997 35.8034 82.036 35.9955 81.5525 35.9955ZM66.9685 23.2345V34.1725H81.5525V23.2345H66.9685Z"
                fill="#798BAF"
            />
            <path
                d="M99.3041 32.9057H93.5841V28.9321H99.0077V27.6503H93.5841V23.9411H99.3041V22.6433H92.142V34.2035H99.3041V32.9057ZM104.792 30.967L106.835 34.2275H108.469L105.497 29.8534L108.429 25.5914H106.867L104.84 28.8039H104.712L102.661 25.5914H101.018L104.007 29.9095L101.051 34.2275H102.613L104.664 30.967H104.792ZM114.549 25.4152C113.372 25.4152 112.338 26.016 111.786 27.0094H111.657V25.5674H110.344V37.0875H111.721V32.9057H111.85C112.322 33.819 113.316 34.3557 114.549 34.3557C116.745 34.3557 118.179 32.5852 118.179 29.8854C118.179 27.1696 116.753 25.4152 114.549 25.4152ZM114.221 33.114C112.667 33.114 111.681 31.8642 111.681 29.8854C111.681 27.8987 112.667 26.6569 114.229 26.6569C115.807 26.6569 116.753 27.8666 116.753 29.8854C116.753 31.9043 115.807 33.114 114.221 33.114ZM120.422 34.2035H121.8V22.1386H120.422V34.2035ZM126.879 34.3557C128.032 34.3557 128.978 33.851 129.538 32.9297H129.667V34.2035H130.98V28.2912C130.98 26.4967 129.803 25.4152 127.696 25.4152C125.853 25.4152 124.491 26.3285 124.307 27.7144H125.701C125.893 27.0334 126.614 26.6409 127.648 26.6409C128.938 26.6409 129.603 27.2257 129.603 28.2912V29.0763L127.111 29.2285C125.1 29.3487 123.963 30.2379 123.963 31.7841C123.963 33.3623 125.204 34.3557 126.879 34.3557ZM127.135 33.146C126.134 33.146 125.389 32.6333 125.389 31.7521C125.389 30.8868 125.965 30.4302 127.279 30.3421L129.603 30.1899V30.983C129.603 32.2167 128.553 33.146 127.135 33.146ZM134.249 23.9011C134.778 23.9011 135.21 23.4684 135.21 22.9397C135.21 22.411 134.778 21.9784 134.249 21.9784C133.72 21.9784 133.288 22.411 133.288 22.9397C133.288 23.4684 133.72 23.9011 134.249 23.9011ZM133.56 34.2035H134.938V25.5674H133.56V34.2035ZM137.566 34.2035H138.944V29.0923C138.944 27.5782 139.833 26.6569 141.211 26.6569C142.589 26.6569 143.246 27.3939 143.246 28.9481V34.2035H144.624V28.6117C144.624 26.5608 143.542 25.4152 141.603 25.4152C140.282 25.4152 139.44 25.976 139.008 26.9293H138.88V25.5674H137.566V34.2035Z"
                fill="#343A4D"
            />
            <path
                d="M153.431 25.3264L157.605 29.5011L161.789 25.3264L163.074 26.6116L157.605 32.0806L152.136 26.6116L153.431 25.3264Z"
                fill="#798BAF"
            />
            <rect
                x="53.0684"
                y="13.7854"
                width="120.261"
                height="29.8362"
                rx="7.51987"
                stroke="#DBE2F0"
                strokeWidth="1.36725"
            />
            <rect x="180.165" y="13.7854" width="136.261" height="29.8362" rx="7.51987" fill="white" />
            <path
                d="M192.242 28.7035C192.242 33.2337 195.916 36.907 200.446 36.907C202.624 36.907 204.712 36.0502 206.279 34.5371L204.912 33.1698C203.754 34.4004 202.141 35.084 200.446 35.084C194.758 35.084 191.914 28.2113 195.934 24.1916C199.953 20.1719 206.826 23.0249 206.826 28.7035H204.092L207.738 32.3495H207.829L211.384 28.7035H208.649C208.649 24.1733 204.976 20.5 200.446 20.5C195.916 20.5 192.242 24.1733 192.242 28.7035Z"
                fill="#798BAF"
            />
            <path
                d="M228.94 29.7332V28.3232H224.254V29.589H227.506V29.8694C227.506 31.8242 226.104 33.146 224.037 33.146C221.714 33.146 220.272 31.3355 220.272 28.4194C220.272 25.5434 221.738 23.7008 224.029 23.7008C225.744 23.7008 226.905 24.5259 227.402 26.0881H228.868C228.452 23.7969 226.593 22.3709 224.029 22.3709C220.865 22.3709 218.79 24.7663 218.79 28.4194C218.79 32.1206 220.833 34.4759 224.029 34.4759C226.986 34.4759 228.94 32.5852 228.94 29.7332ZM237.04 31.9684C236.679 32.7294 235.926 33.138 234.813 33.138C233.346 33.138 232.393 32.0565 232.321 30.3501V30.286H238.53V29.7573C238.53 27.0735 237.112 25.4152 234.78 25.4152C232.409 25.4152 230.887 27.1776 230.887 29.8935C230.887 32.6253 232.385 34.3557 234.78 34.3557C236.671 34.3557 238.017 33.4424 238.418 31.9684H237.04ZM234.764 26.6329C236.134 26.6329 237.048 27.6423 237.08 29.1724H232.321C232.425 27.6423 233.387 26.6329 234.764 26.6329ZM240.693 34.2035H242.071V29.0923C242.071 27.5782 242.96 26.6569 244.338 26.6569C245.716 26.6569 246.373 27.3939 246.373 28.9481V34.2035H247.751V28.6117C247.751 26.5608 246.669 25.4152 244.73 25.4152C243.409 25.4152 242.567 25.976 242.135 26.9293H242.007V25.5674H240.693V34.2035ZM255.994 31.9684C255.634 32.7294 254.881 33.138 253.767 33.138C252.301 33.138 251.348 32.0565 251.276 30.3501V30.286H257.484V29.7573C257.484 27.0735 256.066 25.4152 253.735 25.4152C251.364 25.4152 249.842 27.1776 249.842 29.8935C249.842 32.6253 251.34 34.3557 253.735 34.3557C255.626 34.3557 256.972 33.4424 257.372 31.9684H255.994ZM253.719 26.6329C255.089 26.6329 256.002 27.6423 256.034 29.1724H251.276C251.38 27.6423 252.341 26.6329 253.719 26.6329ZM259.647 34.2035H261.025V28.852C261.025 27.6343 261.979 26.753 263.292 26.753C263.565 26.753 264.062 26.8011 264.174 26.8332V25.4552C263.997 25.4312 263.709 25.4152 263.485 25.4152C262.339 25.4152 261.346 26.008 261.089 26.8492H260.961V25.5674H259.647V34.2035ZM268.299 34.3557C269.453 34.3557 270.398 33.851 270.959 32.9297H271.087V34.2035H272.401V28.2912C272.401 26.4967 271.224 25.4152 269.117 25.4152C267.274 25.4152 265.912 26.3285 265.728 27.7144H267.122C267.314 27.0334 268.035 26.6409 269.069 26.6409C270.358 26.6409 271.023 27.2257 271.023 28.2912V29.0763L268.532 29.2285C266.521 29.3487 265.383 30.2379 265.383 31.7841C265.383 33.3623 266.625 34.3557 268.299 34.3557ZM268.556 33.146C267.554 33.146 266.809 32.6333 266.809 31.7521C266.809 30.8868 267.386 30.4302 268.7 30.3421L271.023 30.1899V30.983C271.023 32.2167 269.974 33.146 268.556 33.146ZM275.526 23.3323V25.5674H274.132V26.721H275.526V31.9603C275.526 33.6107 276.239 34.2676 278.017 34.2676C278.289 34.2676 278.554 34.2355 278.826 34.1875V33.0258C278.57 33.0499 278.434 33.0579 278.185 33.0579C277.288 33.0579 276.904 32.6253 276.904 31.6079V26.721H278.826V25.5674H276.904V23.3323H275.526ZM286.501 31.9684C286.14 32.7294 285.387 33.138 284.274 33.138C282.808 33.138 281.854 32.0565 281.782 30.3501V30.286H287.991V29.7573C287.991 27.0735 286.573 25.4152 284.242 25.4152C281.871 25.4152 280.348 27.1776 280.348 29.8935C280.348 32.6253 281.846 34.3557 284.242 34.3557C286.132 34.3557 287.478 33.4424 287.879 31.9684H286.501ZM284.226 26.6329C285.596 26.6329 286.509 27.6423 286.541 29.1724H281.782C281.887 27.6423 282.848 26.6329 284.226 26.6329Z"
                fill="#343A4D"
            />
            <path
                d="M296.528 25.3264L300.703 29.5011L304.887 25.3264L306.172 26.6116L300.703 32.0806L295.234 26.6116L296.528 25.3264Z"
                fill="#798BAF"
            />
            <rect
                x="180.165"
                y="13.7854"
                width="136.261"
                height="29.8362"
                rx="7.51987"
                stroke="#DBE2F0"
                strokeWidth="1.36725"
            />
            <rect x="323.263" y="13.7854" width="136.261" height="29.8362" rx="7.51987" fill="white" />
            <g clipPath="url(#clip0_35_36627)">
                <path
                    d="M343.543 17.9935H336.251C335.248 17.9935 334.428 18.8138 334.428 19.8165V30.7545L337.162 28.02H341.72V27.1085C341.72 25.1032 343.351 23.4625 345.366 23.4625V19.8165C345.366 18.8138 344.545 17.9935 343.543 17.9935ZM343.543 20.728H342.175C341.866 21.8127 341.3 22.8244 340.517 23.6995L340.498 23.7177L341.647 24.8571L341.31 25.7777L339.897 24.374L337.618 26.6527L336.989 25.9874L339.295 23.7177C338.738 23.1011 338.283 22.3995 337.946 21.6395H338.849C339.131 22.1864 339.477 22.706 339.897 23.1708C340.535 22.4624 341.022 21.6311 341.328 20.728H336.251V19.8165H339.441V18.905H340.352V19.8165H343.543V20.728ZM352.658 25.2855H345.366C344.363 25.2855 343.543 26.1058 343.543 27.1085V33.489C343.543 34.4916 344.363 35.312 345.366 35.312H351.746L354.481 38.0465V27.1085C354.481 26.1058 353.66 25.2855 352.658 25.2855ZM351.409 34.4005L350.634 32.3496H347.389L346.624 34.4005H345.256L348.328 26.197H349.695L352.776 34.4005H351.409ZM349.012 28.02L350.124 30.9824H347.909L349.012 28.02Z"
                    fill="#798BAF"
                />
            </g>
            <path
                d="M366.783 34.2035V23.9411H370.508V22.6433H361.615V23.9411H365.341V34.2035H366.783ZM371.357 34.2035H372.735V28.852C372.735 27.6343 373.688 26.753 375.002 26.753C375.275 26.753 375.771 26.8011 375.883 26.8332V25.4552C375.707 25.4312 375.419 25.4152 375.194 25.4152C374.049 25.4152 373.055 26.008 372.799 26.8492H372.671V25.5674H371.357V34.2035ZM380.009 34.3557C381.163 34.3557 382.108 33.851 382.669 32.9297H382.797V34.2035H384.111V28.2912C384.111 26.4967 382.933 25.4152 380.826 25.4152C378.984 25.4152 377.622 26.3285 377.438 27.7144H378.831C379.024 27.0334 379.745 26.6409 380.778 26.6409C382.068 26.6409 382.733 27.2257 382.733 28.2912V29.0763L380.241 29.2285C378.231 29.3487 377.093 30.2379 377.093 31.7841C377.093 33.3623 378.335 34.3557 380.009 34.3557ZM380.265 33.146C379.264 33.146 378.519 32.6333 378.519 31.7521C378.519 30.8868 379.096 30.4302 380.41 30.3421L382.733 30.1899V30.983C382.733 32.2167 381.683 33.146 380.265 33.146ZM386.658 34.2035H388.036V29.0923C388.036 27.5782 388.926 26.6569 390.304 26.6569C391.682 26.6569 392.338 27.3939 392.338 28.9481V34.2035H393.716V28.6117C393.716 26.5608 392.635 25.4152 390.696 25.4152C389.374 25.4152 388.533 25.976 388.1 26.9293H387.972V25.5674H386.658V34.2035ZM396.04 27.9307C396.04 29.1805 396.777 29.8774 398.395 30.27L399.877 30.6305C400.798 30.8548 401.247 31.2554 401.247 31.8482C401.247 32.6413 400.414 33.1941 399.252 33.1941C398.147 33.1941 397.458 32.7294 397.225 32.0004H395.807C395.959 33.4344 397.281 34.3557 399.204 34.3557C401.167 34.3557 402.665 33.2902 402.665 31.744C402.665 30.5023 401.88 29.7973 400.254 29.4048L398.924 29.0843C397.906 28.836 397.426 28.4675 397.426 27.8746C397.426 27.1055 398.227 26.5848 399.252 26.5848C400.294 26.5848 400.967 27.0415 401.151 27.7304H402.513C402.328 26.3124 401.071 25.4152 399.26 25.4152C397.426 25.4152 396.04 26.4967 396.04 27.9307ZM404.908 34.2035H406.286V22.1386H404.908V34.2035ZM411.365 34.3557C412.519 34.3557 413.464 33.851 414.025 32.9297H414.153V34.2035H415.467V28.2912C415.467 26.4967 414.289 25.4152 412.182 25.4152C410.34 25.4152 408.978 26.3285 408.793 27.7144H410.187C410.38 27.0334 411.101 26.6409 412.134 26.6409C413.424 26.6409 414.089 27.2257 414.089 28.2912V29.0763L411.597 29.2285C409.587 29.3487 408.449 30.2379 408.449 31.7841C408.449 33.3623 409.691 34.3557 411.365 34.3557ZM411.621 33.146C410.62 33.146 409.875 32.6333 409.875 31.7521C409.875 30.8868 410.452 30.4302 411.766 30.3421L414.089 30.1899V30.983C414.089 32.2167 413.039 33.146 411.621 33.146ZM418.591 23.3323V25.5674H417.197V26.721H418.591V31.9603C418.591 33.6107 419.304 34.2676 421.083 34.2676C421.355 34.2676 421.619 34.2355 421.892 34.1875V33.0258C421.635 33.0499 421.499 33.0579 421.251 33.0579C420.354 33.0579 419.969 32.6253 419.969 31.6079V26.721H421.892V25.5674H419.969V23.3323H418.591ZM429.567 31.9684C429.206 32.7294 428.453 33.138 427.339 33.138C425.873 33.138 424.92 32.0565 424.848 30.3501V30.286H431.057V29.7573C431.057 27.0735 429.639 25.4152 427.307 25.4152C424.936 25.4152 423.414 27.1776 423.414 29.8935C423.414 32.6253 424.912 34.3557 427.307 34.3557C429.198 34.3557 430.544 33.4424 430.945 31.9684H429.567ZM427.291 26.6329C428.661 26.6329 429.575 27.6423 429.607 29.1724H424.848C424.952 27.6423 425.913 26.6329 427.291 26.6329Z"
                fill="#343A4D"
            />
            <path
                d="M439.625 25.3264L443.8 29.5011L447.983 25.3264L449.269 26.6116L443.8 32.0806L438.331 26.6116L439.625 25.3264Z"
                fill="#798BAF"
            />
            <rect
                x="323.263"
                y="13.7854"
                width="136.261"
                height="29.8362"
                rx="7.51987"
                stroke="#DBE2F0"
                strokeWidth="1.36725"
            />
            <rect x="466.359" y="14.3474" width="42.3847" height="28.7122" rx="7.51987" fill="white" />
            <path
                d="M491.198 28.7035C491.198 28.22 491.39 27.7563 491.732 27.4144C492.074 27.0726 492.537 26.8805 493.021 26.8805C493.504 26.8805 493.968 27.0726 494.31 27.4144C494.652 27.7563 494.844 28.22 494.844 28.7035C494.844 29.187 494.652 29.6507 494.31 29.9925C493.968 30.3344 493.504 30.5265 493.021 30.5265C492.537 30.5265 492.074 30.3344 491.732 29.9925C491.39 29.6507 491.198 29.187 491.198 28.7035ZM485.729 28.7035C485.729 28.22 485.921 27.7563 486.263 27.4144C486.605 27.0726 487.068 26.8805 487.552 26.8805C488.035 26.8805 488.499 27.0726 488.841 27.4144C489.183 27.7563 489.375 28.22 489.375 28.7035C489.375 29.187 489.183 29.6507 488.841 29.9925C488.499 30.3344 488.035 30.5265 487.552 30.5265C487.068 30.5265 486.605 30.3344 486.263 29.9925C485.921 29.6507 485.729 29.187 485.729 28.7035ZM480.26 28.7035C480.26 28.22 480.452 27.7563 480.794 27.4144C481.136 27.0726 481.599 26.8805 482.083 26.8805C482.566 26.8805 483.03 27.0726 483.372 27.4144C483.714 27.7563 483.906 28.22 483.906 28.7035C483.906 29.187 483.714 29.6507 483.372 29.9925C483.03 30.3344 482.566 30.5265 482.083 30.5265C481.599 30.5265 481.136 30.3344 480.794 29.9925C480.452 29.6507 480.26 29.187 480.26 28.7035Z"
                fill="#798BAF"
            />
            <rect
                x="466.359"
                y="14.3474"
                width="42.3847"
                height="28.7122"
                rx="7.51987"
                stroke="#DBE2F0"
                strokeWidth="1.36725"
            />
        </g>
        <defs>
            <filter
                id="filter0_d_35_36627"
                x="0.429253"
                y="0.796502"
                width="529.126"
                height="61.283"
                filterUnits="userSpaceOnUse"
                colorInterpolationFilters="sRGB"
            >
                <feFlood floodOpacity="0" result="BackgroundImageFix" />
                <feColorMatrix
                    in="SourceAlpha"
                    type="matrix"
                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                    result="hardAlpha"
                />
                <feOffset dx="1.36725" dy="2.7345" />
                <feGaussianBlur stdDeviation="5.469" />
                <feComposite in2="hardAlpha" operator="out" />
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0" />
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_35_36627" />
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_35_36627" result="shape" />
            </filter>
            <clipPath id="clip0_35_36627">
                <rect width="21.876" height="21.876" fill="white" transform="translate(333.518 17.7655)" />
            </clipPath>
        </defs>
    </svg>
)

const AUTO_DISMISS_ON_EVENTS = new Set([
    EventName.CODY_SIDEBAR_CHAT_OPENED,
    EventName.CODY_SIDEBAR_EDIT,
    EventName.CODY_SIDEBAR_RECIPE,
    EventName.CODY_SIDEBAR_RECIPE_EXECUTED,
    EventName.CODY_SIDEBAR_SUBMIT,
])

function useTryCodyWidget(telemetryService: TelemetryProps['telemetryService']): {
    isDismissed: boolean | undefined
    onDismiss: () => void
} {
    const [isDismissed, setIsDismissed] = useTemporarySetting('cody.blobPageCta.dismissed', true)

    const onDismiss = useCallback(() => {
        setIsDismissed(true)
    }, [setIsDismissed])

    // Listen for telemetry events to auto dismiss the widget
    useEffect(() => {
        if (isDismissed) {
            return
        }

        return telemetryService.addEventLogListener?.(eventName => {
            if (AUTO_DISMISS_ON_EVENTS.has(eventName as EventName)) {
                onDismiss()
            }
        })
    }, [telemetryService, isDismissed, onDismiss])

    return { isDismissed, onDismiss }
}

export const TryCodyWidget: React.FC<TelemetryProps & { className?: string }> = ({ className, telemetryService }) => {
    const { isDismissed, onDismiss } = useTryCodyWidget(telemetryService)
    useEffect(() => {
        if (isDismissed) {
            return
        }
        telemetryService.log(EventName.TRY_CODY_WEB_ONBOARDING_DISPLAYED, { type: 'BlobPage' }, { type: 'BlobPage' })
    }, [isDismissed, telemetryService])

    if (isDismissed) {
        return null
    }

    return (
        <MarketingBlock
            wrapperClassName={className}
            contentClassName={classNames('d-flex position-relative py-3 overflow-auto', styles.card)}
            variant="thin"
        >
            <div>
                <GlowingCodySVG />
            </div>
            <div className="flex-grow-1">
                <H4>Try Cody on public code</H4>
                <ol className="m-0">
                    <Text as="li">Select code in the file below</Text>
                    <li>
                        <div className="d-flex flex-column">
                            <Text>Select an action with Cody widget:</Text>
                            <CodyPopupSVG />
                        </div>
                    </li>
                </ol>
            </div>
            <Button className={classNames(styles.closeButton, 'position-absolute mt-2')} onClick={onDismiss}>
                <Icon svgPath={mdiClose} aria-label="Close try Cody widget" />
            </Button>
        </MarketingBlock>
    )
}
