<div class="phui-box phui-box-border phui-object-box mlt mll mlr phui-object-box-collapsed phui-box-blue-property "><div class="phui-header-shell "><h1 class="phui-header-view"><div class="phui-header-row"><div class="phui-header-col2"><span class="phui-header-header">Diff 1</span></div><div class="phui-header-col3"></div></div></h1></div><div class="differential-review-stage" id="differential-review-stage"><div class="differential-changeset repository-crossreference sg-mounted" id="diff-change-i2hTAYOJp2ME" data-sigil="differential-changeset" data-meta="0_44" data-autoid="autoid_1"><legend class="phabricator-anchor-navigation-marker" data-sigil="marker" data-meta="0_42"></legend><a name="change-i2hTAYOJp2ME" id="change-i2hTAYOJp2ME" class="phabricator-anchor-view"></a><div class="differential-changeset-buttons"><div class="sourcegraph-app-annotator" style="display: inline-block;"><ul class="code-view-toolbar"> <li class="code-view-toolbar__item"><a href="https://80bd068b.ngrok.io/github.com/sourcegraph/jsonrpc2/-/compare/35a74f039c6a54af5bf0402d8f7da046c3f63ba2...880ad59426247e2c6dc564dee6c680afe682a55b?utm_source=phabricator-integration#diff-3ef8fa70102f84ab1c1e85853eb28a70" aria-label="View file diff on Sourcegraph" class="open-on-sourcegraph button grey action-item--phabricator"><svg viewBox="0 0 40 40" class="action-item__icon--phabricator"><g fill="none" fill-rule="evenodd"><path d="M11.5941935,5.12629921 L20.4929032,36.888189 C21.0909677,39.0226772 23.3477419,40.279685 25.5325806,39.6951181 C27.7190323,39.1105512 29.0051613,36.9064567 28.4067742,34.7722835 L19.5064516,3.00944882 C18.9080645,0.875590551 16.6516129,-0.381732283 14.4667742,0.203149606 C12.2822581,0.786771654 10.9958065,2.99149606 11.5941935,5.12598425 L11.5941935,5.12629921 Z" fill="#F96316"></path><path d="M28.0722581,5.00598425 L5.7883871,29.5748031 C4.28516129,31.2314961 4.44225806,33.7647244 6.13741935,35.2327559 C7.83258065,36.7004724 10.4245161,36.5474016 11.9277419,34.8913386 L34.2116129,10.3228346 C35.7148387,8.66614173 35.5577419,6.13385827 33.8625806,4.66551181 C32.1667742,3.19653543 29.5741935,3.34992126 28.0722581,5.00566929 L28.0722581,5.00598425 Z" fill="#B200F8"></path><path d="M2.82258065,18.6204724 L34.6019355,28.8866142 C36.7525806,29.5811024 39.0729032,28.4412598 39.7841935,26.3395276 C40.4970968,24.2381102 39.3293548,21.9716535 37.1777419,21.2762205 L5.39935484,11.0110236 C3.24774194,10.3159055 0.928387097,11.455748 0.216774194,13.5574803 C-0.494193548,15.6588976 0.673548387,17.9259843 2.82322581,18.6204724 L2.82258065,18.6204724 Z" fill="#00B4F2"></path></g></svg> </a></li> </ul></div> <a class="button button-grey has-icon has-text phui-button-default" href="#" role="button" data-sigil="differential-view-options" data-meta="0_38" data-autoid="autoid_31" aria-expanded="false"><span class="visual-only phui-icon-view phui-font-fa fa-bars" data-meta="0_39" aria-hidden="true"></span><div class="phui-button-text">View Options</div></a></div><h1 class="differential-file-icon-header"><span class="visual-only phui-icon-view phui-font-fa fa-file-text-o" data-meta="0_43" aria-hidden="true"></span>handler_with_error.go</h1><div class="changeset-view-content" data-sigil="changeset-view-content"><table class="differential-diff remarkup-code PhabricatorMonospaced diff-1up" data-sigil="differential-diff"><colgroup><col class="num"><col class="num"><col class="copy"><col class="unified"></colgroup><tbody><tr data-sigil="context-target"><td class="show-more" colspan="4"><a href="#" data-mustcapture="1" data-sigil="show-more" data-meta="4_0">Show All 25 Lines</a></td></tr><tr><td id="C1OL26" class="n" data-n="26"></td><td id="C1NL26" class="right n" data-n="26"></td><td class="copy"></td><td class="right annotated"><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span>return</span><span>
</span></td></tr><tr><td id="C1OL27" class="n" data-n="27"></td><td id="C1NL27" class="right n" data-n="27"></td><td class="copy"></td><td class="right annotated"><span data-copy-text="	">  </span><span>}</span><span>
</span></td></tr><tr><td id="C1OL28" class="n" data-n="28"></td><td id="C1NL28" class="right n" data-n="28"></td><td class="copy"></td><td class="right annotated"><span>
</span></td></tr><tr><td id="C1OL29" class="n" data-n="29"></td><td id="C1NL29" class="right n" data-n="29"></td><td class="copy"></td><td class="right annotated"><span data-copy-text="	">  </span><span>resp</span><span> </span><span><span>:</span></span><span><span>=</span></span><span> </span><span><span>&amp;</span></span><span><span>Response</span></span><span><span>{</span></span><span><span>ID</span></span><span><span>:</span></span><span> </span><span><span>req</span></span><span><span>.</span></span><span><span>ID</span></span><span><span>}</span></span><span>
</span></td></tr><tr><td id="C1OL30" class="n" data-n="30"></td><td id="C1NL30" class="right n" data-n="30"></td><td class="copy"></td><td class="right annotated"><span data-copy-text="	">  </span><span>if</span><span> </span><span><span>err</span></span><span> </span><span><span>=</span></span><span><span>=</span></span><span> </span><span><span>nil</span></span><span> </span><span><span>{</span></span><span>
</span></td></tr><tr><td id="C1OL31" class="n" data-n="31"></td><td id="C1NL31" class="right n" data-n="31"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span><span data-copy-text="	">  </span>err = resp.SetResult(result)
</td></tr><tr><td id="C1OL32" class="n" data-n="32"></td><td id="C1NL32" class="right n" data-n="32"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span>}
</td></tr><tr><td id="C1OL33" class="n" data-n="33"></td><td id="C1NL33" class="right n" data-n="33"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span>if err != nil {
</td></tr><tr><td id="C1OL34" class="left old old-full n" data-n="34"></td><td class="left old old-full n"></td><td class="copy"></td><td class="left old old-full"><span class="aural-only">- </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>if e, ok := err.(*Error); ok {
</td></tr><tr><td id="C1OL35" class="left old old-full n" data-n="35"></td><td class="left old old-full n"></td><td class="copy"></td><td class="left old old-full"><span class="aural-only">- </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>resp.Error = e
</td></tr><tr><td id="C1OL36" class="left old old-full n" data-n="36"></td><td class="left old old-full n"></td><td class="copy"></td><td class="left old old-full"><span class="aural-only">- </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>} else {
</td></tr><tr><td id="C1OL37" class="left old old-full n" data-n="37"></td><td class="left old old-full n"></td><td class="copy"></td><td class="left old old-full"><span class="aural-only">- </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>resp.Error = &amp;Error{Message: err.Error()}
</td></tr><tr><td id="C1OL38" class="n" data-n="38"></td><td id="C1NL34" class="right n" data-n="34"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span><span data-copy-text="	">  </span>}
</td></tr><tr><td id="C1OL39" class="n" data-n="39"></td><td id="C1NL35" class="right n" data-n="35"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span>}
</td></tr><tr><td id="C1OL40" class="n" data-n="40"></td><td id="C1NL36" class="right n" data-n="36"></td><td class="copy"></td><td class="right">
</td></tr><tr><td id="C1OL41" class="n" data-n="41"></td><td id="C1NL37" class="right n" data-n="37"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span>if !req.Notif {
</td></tr><tr><td id="C1OL42" class="n" data-n="42"></td><td id="C1NL38" class="right n" data-n="38"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span><span data-copy-text="	">  </span>if err := conn.SendResponse(ctx, resp); err != nil {
</td></tr><tr><td id="C1OL43" class="n" data-n="43"></td><td id="C1NL39" class="right n" data-n="39"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>if err != ErrClosed || !h.suppressErrClosed {
</td></tr><tr><td id="C1OL44" class="n" data-n="44"></td><td id="C1NL40" class="right n" data-n="40"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>log.Printf("jsonrpc2 handler: sending response %s: %s", resp.ID, err)
</td></tr><tr><td id="C1OL45" class="n" data-n="45"></td><td id="C1NL41" class="right n" data-n="41"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>}
</td></tr><tr data-sigil="context-target"><td class="show-more" colspan="4"><a href="#" data-mustcapture="1" data-sigil="show-more" data-meta="4_1">Show All 11 Lines</a></td></tr><tr><td id="C1OL57" class="n" data-n="57"></td><td id="C1NL53" class="right n" data-n="53"></td><td class="copy"></td><td class="right">// interested in the request and closed the connection, etc) and as such it
</td></tr><tr><td id="C1OL58" class="n" data-n="58"></td><td id="C1NL54" class="right n" data-n="54"></td><td class="copy"></td><td class="right">// would be log spam, whereas a handler that serves internal connections would
</td></tr><tr><td id="C1OL59" class="n" data-n="59"></td><td id="C1NL55" class="right n" data-n="55"></td><td class="copy"></td><td class="right">// never expect connections to go away unexpectedly (which could indicate
</td></tr><tr><td id="C1OL60" class="n" data-n="60"></td><td id="C1NL56" class="right n" data-n="56"></td><td class="copy"></td><td class="right">// service degradation, etc) and as such ErrClosed should always be logged.
</td></tr><tr><td id="C1OL61" class="n" data-n="61"></td><td id="C1NL57" class="right n" data-n="57"></td><td class="copy"></td><td class="right">func (h *HandlerWithErrorConfigurer) SuppressErrClosed() Handler {
</td></tr><tr><td id="C1OL62" class="n" data-n="62"></td><td id="C1NL58" class="right n" data-n="58"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span>h.suppressErrClosed = true
</td></tr><tr><td id="C1OL63" class="n" data-n="63"></td><td id="C1NL59" class="right n" data-n="59"></td><td class="copy"></td><td class="right"><span data-copy-text="	">  </span>return h
</td></tr><tr><td id="C1OL64" class="n" data-n="64"></td><td id="C1NL60" class="right n" data-n="60"></td><td class="copy"></td><td class="right">}
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL61" class="right new new-full n" data-n="61"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL62" class="right new new-full n" data-n="62"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL63" class="right new new-full n" data-n="63"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>// random will create a file of size bytes (rounded up to next 1024 size)
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL64" class="right new new-full n" data-n="64"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>func randoasfasfafsm_1(size int) error {
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL65" class="right new new-full n" data-n="65"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>const bufSize = 1024
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL66" class="right new new-full n" data-n="66"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL67" class="right new new-full n" data-n="67"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>f, err := os.Create("/tmp/test")
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL68" class="right new new-full n" data-n="68"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL69" class="right new new-full n" data-n="69"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>fb := bufio.NewWriter(f)
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL70" class="right new new-full n" data-n="70"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>defer fb.Flush()
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL71" class="right new new-full n" data-n="71"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL72" class="right new new-full n" data-n="72"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>buf := make([]byte, bufSize)
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL73" class="right new new-full n" data-n="73"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL74" class="right new new-full n" data-n="74"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>for i := size; i &gt; 0; i -= bufSize {
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL75" class="right new new-full n" data-n="75"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>if _, err = rand.Read(buf); err != nil {
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL76" class="right new new-full n" data-n="76"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>fmt.Printf("error occurred during random: %!s(MISSING)\n", err)
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL77" class="right new new-full n" data-n="77"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>break
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL78" class="right new new-full n" data-n="78"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>}
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL79" class="right new new-full n" data-n="79"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>bR := bytes.NewReader(buf)
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL80" class="right new new-full n" data-n="80"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>if _, err = io.Copy(fb, bR); err != nil {
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL81" class="right new new-full n" data-n="81"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>fmt.Printf("failed during copy: %!s(MISSING)\n", err)
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL82" class="right new new-full n" data-n="82"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>break
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL83" class="right new new-full n" data-n="83"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span><span data-copy-text="	">  </span>}
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL84" class="right new new-full n" data-n="84"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>}
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL85" class="right new new-full n" data-n="85"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL86" class="right new new-full n" data-n="86"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span><span data-copy-text="	">  </span>return err
</td></tr><tr><td class="right new new-full n"></td><td id="C1NL87" class="right new new-full n" data-n="87"></td><td class="copy"></td><td class="right new new-full"><span class="aural-only">+ </span>}
</td></tr></tbody></table></div></div></div></div>