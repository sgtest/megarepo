import { BehaviorSubject, combineLatest, isObservable, of } from 'rxjs';
import { distinctUntilChanged, map, switchMap } from 'rxjs/operators';
import { flatten, isEqual } from '../../util';
import { getComputedContextProperty } from '../context/context';
import { evaluate, evaluateTemplate } from '../context/expr/evaluator';
import { TEMPLATE_BEGIN } from '../context/expr/lexer';
/** Manages and executes contributions from all extensions. */
export class ContributionRegistry {
    constructor(environment) {
        this.environment = environment;
        /** All entries, including entries that are not enabled in the current context. */
        this._entries = new BehaviorSubject([]);
        /**
         * All contribution entries, emitted whenever the set of registered contributions changes.
         *
         * Most callers should use ContributionsRegistry#getContributions. Only use #entries if the
         * caller needs information that is discarded when the contributions are merged (such as the
         * extension that registered each set of contributions).
         */
        this.entries = this._entries;
    }
    /** Register contributions and return an unsubscribable that deregisters the contributions. */
    registerContributions(entry) {
        this._entries.next([...this._entries.value, entry]);
        return {
            unsubscribe: () => {
                this._entries.next(this._entries.value.filter(e => e !== entry));
            },
            entry,
        };
    }
    /**
     * Atomically deregister the previous contributions and register the next contributions. The registry's observable
     * emits only one time after both operations are complete (instead of also emitting after the deregistration
     * and before the registration).
     */
    replaceContributions(previous, next) {
        this._entries.next([...this._entries.value.filter(e => e !== previous.entry), next]);
        return {
            unsubscribe: () => {
                this._entries.next(this._entries.value.filter(e => e !== next));
            },
            entry: next,
        };
    }
    /**
     * Returns an observable that emits all contributions (merged) evaluated in the current
     * environment (with the optional scope). It emits whenever there is any change.
     */
    getContributions(scope) {
        return this.getContributionsFromEntries(this._entries, scope);
    }
    getContributionsFromEntries(entries, scope) {
        return combineLatest(entries.pipe(switchMap(entries => combineLatest(...entries.map(entry => (isObservable(entry.contributions) ? entry.contributions : of(entry.contributions)))))), this.environment).pipe(map(([multiContributions, environment]) => {
            const computedContext = { get: (key) => getComputedContextProperty(environment, key, scope) };
            return flatten(multiContributions).map(contributions => {
                try {
                    return evaluateContributions(computedContext, filterContributions(computedContext, contributions));
                }
                catch (err) {
                    // An error during evaluation causes all of the contributions in the same entry to be
                    // discarded.
                    console.error('Discarding contributions: evaluating expressions or templates failed.', {
                        contributions,
                        err,
                    });
                    return {};
                }
            });
        }), map(c => mergeContributions(c)), distinctUntilChanged((a, b) => isEqual(a, b)));
    }
}
/**
 * Merges the contributions.
 *
 * Most callers should use ContributionRegistry#getContributions, which merges all registered
 * contributions.
 */
export function mergeContributions(contributions) {
    if (contributions.length === 0) {
        return {};
    }
    if (contributions.length === 1) {
        return contributions[0];
    }
    const merged = {};
    for (const c of contributions) {
        if (c.actions) {
            if (!merged.actions) {
                merged.actions = [...c.actions];
            }
            else {
                merged.actions = [...merged.actions, ...c.actions];
            }
        }
        if (c.menus) {
            if (!merged.menus) {
                merged.menus = Object.assign({}, c.menus);
            }
            else {
                for (const [menu, items] of Object.entries(c.menus)) {
                    if (!merged.menus[menu]) {
                        merged.menus[menu] = [...items];
                    }
                    else {
                        merged.menus[menu] = [...merged.menus[menu], ...items];
                    }
                }
            }
        }
    }
    return merged;
}
/** Filters out items whose `when` context expression evaluates to false (or a falsey value). */
export function contextFilter(context, items, evaluateExpr = evaluate) {
    const keep = [];
    for (const item of items) {
        if (item.when !== undefined && !evaluateExpr(item.when, context)) {
            continue; // omit
        }
        keep.push(item);
    }
    return keep;
}
/** Filters the contributions to only those that are enabled in the current context. */
export function filterContributions(context, contributions, evaluateExpr = evaluate) {
    if (!contributions.menus) {
        return contributions;
    }
    const filteredMenus = {};
    for (const [menu, items] of Object.entries(contributions.menus)) {
        filteredMenus[menu] = contextFilter(context, items, evaluateExpr);
    }
    return Object.assign({}, contributions, { menus: filteredMenus });
}
const DEFAULT_TEMPLATE_EVALUATOR = {
    evaluateTemplate,
    needsEvaluation: (template) => template.includes(TEMPLATE_BEGIN),
};
/**
 * Evaluates expressions in contribution definitions against the given context.
 */
export function evaluateContributions(context, contributions, { evaluateTemplate, needsEvaluation } = DEFAULT_TEMPLATE_EVALUATOR) {
    if (!contributions.actions || contributions.actions.length === 0) {
        return contributions;
    }
    const evaluatedActions = [];
    for (const action of contributions.actions) {
        const changed = {};
        if (action.commandArguments) {
            for (const [i, arg] of action.commandArguments.entries()) {
                if (typeof arg === 'string' && needsEvaluation(arg)) {
                    const evaluatedArg = evaluateTemplate(arg, context);
                    if (changed.commandArguments) {
                        changed.commandArguments.push(evaluatedArg);
                    }
                    else {
                        changed.commandArguments = action.commandArguments.slice(0, i).concat(evaluatedArg);
                    }
                }
                else if (changed.commandArguments) {
                    changed.commandArguments.push(arg);
                }
            }
        }
        if (action.title && needsEvaluation(action.title)) {
            changed.title = evaluateTemplate(action.title, context);
        }
        if (action.category && needsEvaluation(action.category)) {
            changed.category = evaluateTemplate(action.category, context);
        }
        if (action.description && needsEvaluation(action.description)) {
            changed.description = evaluateTemplate(action.description, context);
        }
        if (action.iconURL && needsEvaluation(action.iconURL)) {
            changed.iconURL = evaluateTemplate(action.iconURL, context);
        }
        if (action.actionItem) {
            const changedActionItem = {};
            if (action.actionItem.label && needsEvaluation(action.actionItem.label)) {
                changedActionItem.label = evaluateTemplate(action.actionItem.label, context);
            }
            if (action.actionItem.description && needsEvaluation(action.actionItem.description)) {
                changedActionItem.description = evaluateTemplate(action.actionItem.description, context);
            }
            if (action.actionItem.iconURL && needsEvaluation(action.actionItem.iconURL)) {
                changedActionItem.iconURL = evaluateTemplate(action.actionItem.iconURL, context);
            }
            if (action.actionItem.iconDescription && needsEvaluation(action.actionItem.iconDescription)) {
                changedActionItem.iconDescription = evaluateTemplate(action.actionItem.iconDescription, context);
            }
            if (Object.keys(changedActionItem).length !== 0) {
                changed.actionItem = Object.assign({}, action.actionItem, changedActionItem);
            }
        }
        const modified = Object.keys(changed).length !== 0;
        evaluatedActions.push(modified ? Object.assign({}, action, changed) : action);
    }
    return Object.assign({}, contributions, { actions: evaluatedActions });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJpYnV0aW9uLmpzIiwic291cmNlUm9vdCI6InNyYy8iLCJzb3VyY2VzIjpbImNsaWVudC9wcm92aWRlcnMvY29udHJpYnV0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBK0IsRUFBRSxFQUFrQixNQUFNLE1BQU0sQ0FBQTtBQUNwSCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBU3JFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzdDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQy9ELE9BQU8sRUFBbUIsUUFBUSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDdkYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFBO0FBd0J0RCw4REFBOEQ7QUFDOUQsTUFBTSxPQUFPLG9CQUFvQjtJQUk3QixZQUEyQixXQUFvQztRQUFwQyxnQkFBVyxHQUFYLFdBQVcsQ0FBeUI7UUFIL0Qsa0ZBQWtGO1FBQzFFLGFBQVEsR0FBRyxJQUFJLGVBQWUsQ0FBdUIsRUFBRSxDQUFDLENBQUE7UUFpRmhFOzs7Ozs7V0FNRztRQUNhLFlBQU8sR0FBdUUsSUFBSSxDQUFDLFFBQVEsQ0FBQTtJQXRGekMsQ0FBQztJQUVuRSw4RkFBOEY7SUFDdkYscUJBQXFCLENBQUMsS0FBeUI7UUFDbEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDbkQsT0FBTztZQUNILFdBQVcsRUFBRSxHQUFHLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENB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Q0FBQyxDQUFBO2FBQzNGO1lBQ0QsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sSUFBSSxlQUFlLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDekUsaUJBQWlCLENBQUMsT0FBTyxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFBO2FBQ25GO1lBQ0QsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLGVBQWUsSUFBSSxlQUFlLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRTtnQkFDekYsaUJBQWlCLENBQUMsZUFBZSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFBO2FBQ25HO1lBQ0QsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDN0MsT0FBTyxDQUFDLFVBQVUscUJBQVEsTUFBTSxDQUFDLFVBQVUsRUFBSyxpQkFBaUIsQ0FBRSxDQUFBO2FBQ3RFO1NBQ0o7UUFDRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUE7UUFDbEQsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLG1CQUFNLE1BQU0sRUFBSyxPQUFPLEVBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0tBQ3ZFO0lBQ0QseUJBQVksYUFBYSxJQUFFLE9BQU8sRUFBRSxnQkFBZ0IsSUFBRTtBQUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBpc09ic2VydmFibGUsIE9ic2VydmFibGUsIE9ic2VydmFibGVJbnB1dCwgb2YsIFVuc3Vic2NyaWJhYmxlIH0gZnJvbSAncnhqcydcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xuaW1wb3J0IHtcbiAgICBBY3Rpb25Db250cmlidXRpb24sXG4gICAgQWN0aW9uSXRlbSxcbiAgICBDb250cmlidXRhYmxlTWVudSxcbiAgICBDb250cmlidXRpb25zLFxuICAgIE1lbnVDb250cmlidXRpb25zLFxuICAgIE1lbnVJdGVtQ29udHJpYnV0aW9uLFxufSBmcm9tICcuLi8uLi9wcm90b2NvbCdcbmltcG9ydCB7IGZsYXR0ZW4sIGlzRXF1YWwgfSBmcm9tICcuLi8uLi91dGlsJ1xuaW1wb3J0IHsgZ2V0Q29tcHV0ZWRDb250ZXh0UHJvcGVydHkgfSBmcm9tICcuLi9jb250ZXh0L2NvbnRleHQnXG5pbXBvcnQgeyBDb21wdXRlZENvbnRleHQsIGV2YWx1YXRlLCBldmFsdWF0ZVRlbXBsYXRlIH0gZnJvbSAnLi4vY29udGV4dC9leHByL2V2YWx1YXRvcidcbmltcG9ydCB7IFRFTVBMQVRFX0JFR0lOIH0gZnJvbSAnLi4vY29udGV4dC9leHByL2xleGVyJ1xuaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tICcuLi9lbnZpcm9ubWVudCdcbmltcG9ydCB7IFRleHREb2N1bWVudEl0ZW0gfSBmcm9tICcuLi90eXBlcy90ZXh0RG9jdW1lbnQnXG5cbi8qKiBBIHJlZ2lzdGVyZWQgc2V0IG9mIGNvbnRyaWJ1dGlvbnMgZnJvbSBhbiBleHRlbnNpb24gaW4gdGhlIHJlZ2lzdHJ5LiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb250cmlidXRpb25zRW50cnkge1xuICAgIC8qKlxuICAgICAqIFRoZSBjb250cmlidXRpb25zLCBlaXRoZXIgYXMgYSB2YWx1ZSBvciBhbiBvYnNlcnZhYmxlLlxuICAgICAqXG4gICAgICogSWYgYW4gb2JzZXJ2YWJsZSBpcyB1c2VkLCBpdCBzaG91bGQgYmUgYSBjb2xkIE9ic2VydmFibGUgYW5kIGVtaXQgKGUuZy4sIGl0cyBjdXJyZW50IHZhbHVlKSB1cG9uXG4gICAgICogc3Vic2NyaXB0aW9uLiBUaGUge0BsaW5rIENvbnRyaWJ1dGlvblJlZ2lzdHJ5I2NvbnRyaWJ1dGlvbnN9IG9ic2VydmFibGUgYmxvY2tzIHVudGlsIGFsbCBvYnNlcnZhYmxlcyBoYXZlXG4gICAgICogZW1pdHRlZC5cbiAgICAgKi9cbiAgICBjb250cmlidXRpb25zOiBDb250cmlidXRpb25zIHwgT2JzZXJ2YWJsZUlucHV0PENvbnRyaWJ1dGlvbnMgfCBDb250cmlidXRpb25zW10+XG59XG5cbi8qKlxuICogQW4gdW5zdWJzY3JpYmFibGUgdGhhdCBkZXJlZ2lzdGVycyB0aGUgY29udHJpYnV0aW9ucyBpdCBpcyBhc3NvY2lhdGVkIHdpdGguIEl0IGNhbiBhbHNvIGJlIHVzZWQgaW5cbiAqIENvbnRyaWJ1dGlvblJlZ2lzdHJ5I3JlcGxhY2VDb250cmlidXRpb25zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbnRyaWJ1dGlvblVuc3Vic2NyaWJhYmxlIGV4dGVuZHMgVW5zdWJzY3JpYmFibGUge1xuICAgIGVudHJ5OiBDb250cmlidXRpb25zRW50cnlcbn1cblxuLyoqIE1hbmFnZXMgYW5kIGV4ZWN1dGVzIGNvbnRyaWJ1dGlvbnMgZnJvbSBhbGwgZXh0ZW5zaW9ucy4gKi9cbmV4cG9ydCBjbGFzcyBDb250cmlidXRpb25SZWdpc3RyeSB7XG4gICAgLyoqIEFsbCBlbnRyaWVzLCBpbmNsdWRpbmcgZW50cmllcyB0aGF0IGFyZSBub3QgZW5hYmxlZCBpbiB0aGUgY3VycmVudCBjb250ZXh0LiAqL1xuICAgIHByaXZhdGUgX2VudHJpZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PENvbnRyaWJ1dGlvbnNFbnRyeVtdPihbXSlcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGVudmlyb25tZW50OiBPYnNlcnZhYmxlPEVudmlyb25tZW50Pikge31cblxuICAgIC8qKiBSZWdpc3RlciBjb250cmlidXRpb25zIGFuZCByZXR1cm4gYW4gdW5zdWJzY3JpYmFibGUgdGhhdCBkZXJlZ2lzdGVycyB0aGUgY29udHJpYnV0aW9ucy4gKi9cbiAgICBwdWJsaWMgcmVnaXN0ZXJDb250cmlidXRpb25zKGVudHJ5OiBDb250cmlidXRpb25zRW50cnkpOiBDb250cmlidXRpb25VbnN1YnNjcmliYWJsZSB7XG4gICAgICAgIHRoaXMuX2VudHJpZXMubmV4dChbLi4udGhpcy5fZW50cmllcy52YWx1ZSwgZW50cnldKVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdW5zdWJzY3JpYmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9lbnRyaWVzLm5leHQodGhpcy5fZW50cmllcy52YWx1ZS5maWx0ZXIoZSA9PiBlICE9PSBlbnRyeSkpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZW50cnksXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBdG9taWNhbGx5IGRlcmVnaXN0ZXIgdGhlIHByZXZpb3VzIGNvbnRyaWJ1dGlvbnMgYW5kIHJlZ2lzdGVyIHRoZSBuZXh0IGNvbnRyaWJ1dGlvbnMuIFRoZSByZWdpc3RyeSdzIG9ic2VydmFibGVcbiAgICAgKiBlbWl0cyBvbmx5IG9uZSB0aW1lIGFmdGVyIGJvdGggb3BlcmF0aW9ucyBhcmUgY29tcGxldGUgKGluc3RlYWQgb2YgYWxzbyBlbWl0dGluZyBhZnRlciB0aGUgZGVyZWdpc3RyYXRpb25cbiAgICAgKiBhbmQgYmVmb3JlIHRoZSByZWdpc3RyYXRpb24pLlxuICAgICAqL1xuICAgIHB1YmxpYyByZXBsYWNlQ29udHJpYnV0aW9ucyhcbiAgICAgICAgcHJldmlvdXM6IENvbnRyaWJ1dGlvblVuc3Vic2NyaWJhYmxlLFxuICAgICAgICBuZXh0OiBDb250cmlidXRpb25zRW50cnlcbiAgICApOiBDb250cmlidXRpb25VbnN1YnNjcmliYWJsZSB7XG4gICAgICAgIHRoaXMuX2VudHJpZXMubmV4dChbLi4udGhpcy5fZW50cmllcy52YWx1ZS5maWx0ZXIoZSA9PiBlICE9PSBwcmV2aW91cy5lbnRyeSksIG5leHRdKVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdW5zdWJzY3JpYmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9lbnRyaWVzLm5leHQodGhpcy5fZW50cmllcy52YWx1ZS5maWx0ZXIoZSA9PiBlICE9PSBuZXh0KSlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbnRyeTogbmV4dCxcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgYW4gb2JzZXJ2YWJsZSB0aGF0IGVtaXRzIGFsbCBjb250cmlidXRpb25zIChtZXJnZWQpIGV2YWx1YXRlZCBpbiB0aGUgY3VycmVudFxuICAgICAqIGVudmlyb25tZW50ICh3aXRoIHRoZSBvcHRpb25hbCBzY29wZSkuIEl0IGVtaXRzIHdoZW5ldmVyIHRoZXJlIGlzIGFueSBjaGFuZ2UuXG4gICAgICovXG4gICAgcHVibGljIGdldENvbnRyaWJ1dGlvbnMoc2NvcGU/OiBUZXh0RG9jdW1lbnRJdGVtKTogT2JzZXJ2YWJsZTxDb250cmlidXRpb25zPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENvbnRyaWJ1dGlvbnNGcm9tRW50cmllcyh0aGlzLl9lbnRyaWVzLCBzY29wZSlcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0Q29udHJpYnV0aW9uc0Zyb21FbnRyaWVzKFxuICAgICAgICBlbnRyaWVzOiBPYnNlcnZhYmxlPENvbnRyaWJ1dGlvbnNFbnRyeVtdPixcbiAgICAgICAgc2NvcGU/OiBUZXh0RG9jdW1lbnRJdGVtXG4gICAgKTogT2JzZXJ2YWJsZTxDb250cmlidXRpb25zPiB7XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFxuICAgICAgICAgICAgZW50cmllcy5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcChlbnRyaWVzID0+XG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVMYXRlc3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5lbnRyaWVzLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeSA9PiAoaXNPYnNlcnZhYmxlKGVudHJ5LmNvbnRyaWJ1dGlvbnMpID8gZW50cnkuY29udHJpYnV0aW9ucyA6IG9mKGVudHJ5LmNvbnRyaWJ1dGlvbnMpKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHRoaXMuZW52aXJvbm1lbnRcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgbWFwKChbbXVsdGlDb250cmlidXRpb25zLCBlbnZpcm9ubWVudF0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb21wdXRlZENvbnRleHQgPSB7IGdldDogKGtleTogc3RyaW5nKSA9PiBnZXRDb21wdXRlZENvbnRleHRQcm9wZXJ0eShlbnZpcm9ubWVudCwga2V5LCBzY29wZSkgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmbGF0dGVuKG11bHRpQ29udHJpYnV0aW9ucykubWFwKGNvbnRyaWJ1dGlvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2YWx1YXRlQ29udHJpYnV0aW9ucyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wdXRlZENvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQ29udHJpYnV0aW9ucyhjb21wdXRlZENvbnRleHQsIGNvbnRyaWJ1dGlvbnMpXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW4gZXJyb3IgZHVyaW5nIGV2YWx1YXRpb24gY2F1c2VzIGFsbCBvZiB0aGUgY29udHJpYnV0aW9ucyBpbiB0aGUgc2FtZSBlbnRyeSB0byBiZVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGlzY2FyZGVkLlxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRGlzY2FyZGluZyBjb250cmlidXRpb25zOiBldmFsdWF0aW5nIGV4cHJlc3Npb25zIG9yIHRlbXBsYXRlcyBmYWlsZWQuJywge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyaWJ1dGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7fVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKGMgPT4gbWVyZ2VDb250cmlidXRpb25zKGMpKSxcbiAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChhLCBiKSA9PiBpc0VxdWFsKGEsIGIpKVxuICAgICAgICApXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWxsIGNvbnRyaWJ1dGlvbiBlbnRyaWVzLCBlbWl0dGVkIHdoZW5ldmVyIHRoZSBzZXQgb2YgcmVnaXN0ZXJlZCBjb250cmlidXRpb25zIGNoYW5nZXMuXG4gICAgICpcbiAgICAgKiBNb3N0IGNhbGxlcnMgc2hvdWxkIHVzZSBDb250cmlidXRpb25zUmVnaXN0cnkjZ2V0Q29udHJpYnV0aW9ucy4gT25seSB1c2UgI2VudHJpZXMgaWYgdGhlXG4gICAgICogY2FsbGVyIG5lZWRzIGluZm9ybWF0aW9uIHRoYXQgaXMgZGlzY2FyZGVkIHdoZW4gdGhlIGNvbnRyaWJ1dGlvbnMgYXJlIG1lcmdlZCAoc3VjaCBhcyB0aGVcbiAgICAgKiBleHRlbnNpb24gdGhhdCByZWdpc3RlcmVkIGVhY2ggc2V0IG9mIGNvbnRyaWJ1dGlvbnMpLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBlbnRyaWVzOiBPYnNlcnZhYmxlPENvbnRyaWJ1dGlvbnNFbnRyeVtdPiAmIHsgdmFsdWU6IENvbnRyaWJ1dGlvbnNFbnRyeVtdIH0gPSB0aGlzLl9lbnRyaWVzXG59XG5cbi8qKlxuICogTWVyZ2VzIHRoZSBjb250cmlidXRpb25zLlxuICpcbiAqIE1vc3QgY2FsbGVycyBzaG91bGQgdXNlIENvbnRyaWJ1dGlvblJlZ2lzdHJ5I2dldENvbnRyaWJ1dGlvbnMsIHdoaWNoIG1lcmdlcyBhbGwgcmVnaXN0ZXJlZFxuICogY29udHJpYnV0aW9ucy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlQ29udHJpYnV0aW9ucyhjb250cmlidXRpb25zOiBDb250cmlidXRpb25zW10pOiBDb250cmlidXRpb25zIHtcbiAgICBpZiAoY29udHJpYnV0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHt9XG4gICAgfVxuICAgIGlmIChjb250cmlidXRpb25zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gY29udHJpYnV0aW9uc1swXVxuICAgIH1cbiAgICBjb25zdCBtZXJnZWQ6IENvbnRyaWJ1dGlvbnMgPSB7fVxuICAgIGZvciAoY29uc3QgYyBvZiBjb250cmlidXRpb25zKSB7XG4gICAgICAgIGlmIChjLmFjdGlvbnMpIHtcbiAgICAgICAgICAgIGlmICghbWVyZ2VkLmFjdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBtZXJnZWQuYWN0aW9ucyA9IFsuLi5jLmFjdGlvbnNdXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG1lcmdlZC5hY3Rpb25zID0gWy4uLm1lcmdlZC5hY3Rpb25zLCAuLi5jLmFjdGlvbnNdXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGMubWVudXMpIHtcbiAgICAgICAgICAgIGlmICghbWVyZ2VkLm1lbnVzKSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VkLm1lbnVzID0geyAuLi5jLm1lbnVzIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBbbWVudSwgaXRlbXNdIG9mIE9iamVjdC5lbnRyaWVzKGMubWVudXMpIGFzIFtDb250cmlidXRhYmxlTWVudSwgTWVudUl0ZW1Db250cmlidXRpb25bXV1bXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW1lcmdlZC5tZW51c1ttZW51XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLm1lbnVzW21lbnVdID0gWy4uLml0ZW1zXVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLm1lbnVzW21lbnVdID0gWy4uLm1lcmdlZC5tZW51c1ttZW51XSEsIC4uLml0ZW1zXVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtZXJnZWRcbn1cblxuLyoqIEZpbHRlcnMgb3V0IGl0ZW1zIHdob3NlIGB3aGVuYCBjb250ZXh0IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGZhbHNlIChvciBhIGZhbHNleSB2YWx1ZSkuICovXG5leHBvcnQgZnVuY3Rpb24gY29udGV4dEZpbHRlcjxUIGV4dGVuZHMgeyB3aGVuPzogc3RyaW5nIH0+KFxuICAgIGNvbnRleHQ6IENvbXB1dGVkQ29udGV4dCxcbiAgICBpdGVtczogVFtdLFxuICAgIGV2YWx1YXRlRXhwciA9IGV2YWx1YXRlXG4pOiBUW10ge1xuICAgIGNvbnN0IGtlZXA6IFRbXSA9IFtdXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICAgIGlmIChpdGVtLndoZW4gIT09IHVuZGVmaW5lZCAmJiAhZXZhbHVhdGVFeHByKGl0ZW0ud2hlbiwgY29udGV4dCkpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlIC8vIG9taXRcbiAgICAgICAgfVxuICAgICAgICBrZWVwLnB1c2goaXRlbSlcbiAgICB9XG4gICAgcmV0dXJuIGtlZXBcbn1cblxuLyoqIEZpbHRlcnMgdGhlIGNvbnRyaWJ1dGlvbnMgdG8gb25seSB0aG9zZSB0aGF0IGFyZSBlbmFibGVkIGluIHRoZSBjdXJyZW50IGNvbnRleHQuICovXG5leHBvcnQgZnVuY3Rpb24gZmlsdGVyQ29udHJpYnV0aW9ucyhcbiAgICBjb250ZXh0OiBDb21wdXRlZENvbnRleHQsXG4gICAgY29udHJpYnV0aW9uczogQ29udHJpYnV0aW9ucyxcbiAgICBldmFsdWF0ZUV4cHIgPSBldmFsdWF0ZVxuKTogQ29udHJpYnV0aW9ucyB7XG4gICAgaWYgKCFjb250cmlidXRpb25zLm1lbnVzKSB7XG4gICAgICAgIHJldHVybiBjb250cmlidXRpb25zXG4gICAgfVxuICAgIGNvbnN0IGZpbHRlcmVkTWVudXM6IE1lbnVDb250cmlidXRpb25zID0ge31cbiAgICBmb3IgKGNvbnN0IFttZW51LCBpdGVtc10gb2YgT2JqZWN0LmVudHJpZXMoY29udHJpYnV0aW9ucy5tZW51cykgYXMgW0NvbnRyaWJ1dGFibGVNZW51LCBNZW51SXRlbUNvbnRyaWJ1dGlvbltdXVtdKSB7XG4gICAgICAgIGZpbHRlcmVkTWVudXNbbWVudV0gPSBjb250ZXh0RmlsdGVyKGNvbnRleHQsIGl0ZW1zLCBldmFsdWF0ZUV4cHIpXG4gICAgfVxuICAgIHJldHVybiB7IC4uLmNvbnRyaWJ1dGlvbnMsIG1lbnVzOiBmaWx0ZXJlZE1lbnVzIH1cbn1cblxuY29uc3QgREVGQVVMVF9URU1QTEFURV9FVkFMVUFUT1I6IHtcbiAgICBldmFsdWF0ZVRlbXBsYXRlOiAodGVtcGxhdGU6IHN0cmluZywgY29udGV4dDogQ29tcHV0ZWRDb250ZXh0KSA9PiBhbnlcblxuICAgIC8qKlxuICAgICAqIFJlcG9ydHMgd2hldGhlciB0aGUgc3RyaW5nIG5lZWRzIGV2YWx1YXRpb24uIFNraXBwaW5nIGV2YWx1YXRpb24gZm9yIHN0cmluZ3Mgd2hlcmUgaXQgaXMgdW5uZWNlc3NhcnkgaXMgYW5cbiAgICAgKiBvcHRpbWl6YXRpb24uXG4gICAgICovXG4gICAgbmVlZHNFdmFsdWF0aW9uOiAodGVtcGxhdGU6IHN0cmluZykgPT4gYm9vbGVhblxufSA9IHtcbiAgICBldmFsdWF0ZVRlbXBsYXRlLFxuICAgIG5lZWRzRXZhbHVhdGlvbjogKHRlbXBsYXRlOiBzdHJpbmcpID0+IHRlbXBsYXRlLmluY2x1ZGVzKFRFTVBMQVRFX0JFR0lOKSxcbn1cblxuLyoqXG4gKiBFdmFsdWF0ZXMgZXhwcmVzc2lvbnMgaW4gY29udHJpYnV0aW9uIGRlZmluaXRpb25zIGFnYWluc3QgdGhlIGdpdmVuIGNvbnRleHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBldmFsdWF0ZUNvbnRyaWJ1dGlvbnMoXG4gICAgY29udGV4dDogQ29tcHV0ZWRDb250ZXh0LFxuICAgIGNvbnRyaWJ1dGlvbnM6IENvbnRyaWJ1dGlvbnMsXG4gICAgeyBldmFsdWF0ZVRlbXBsYXRlLCBuZWVkc0V2YWx1YXRpb24gfSA9IERFRkFVTFRfVEVNUExBVEVfRVZBTFVBVE9SXG4pOiBDb250cmlidXRpb25zIHtcbiAgICBpZiAoIWNvbnRyaWJ1dGlvbnMuYWN0aW9ucyB8fCBjb250cmlidXRpb25zLmFjdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBjb250cmlidXRpb25zXG4gICAgfVxuICAgIGNvbnN0IGV2YWx1YXRlZEFjdGlvbnM6IEFjdGlvbkNvbnRyaWJ1dGlvbltdID0gW11cbiAgICBmb3IgKGNvbnN0IGFjdGlvbiBvZiBjb250cmlidXRpb25zLmFjdGlvbnMgYXMgUmVhZG9ubHk8QWN0aW9uQ29udHJpYnV0aW9uPltdKSB7XG4gICAgICAgIGNvbnN0IGNoYW5nZWQ6IFBhcnRpYWw8QWN0aW9uQ29udHJpYnV0aW9uPiA9IHt9XG4gICAgICAgIGlmIChhY3Rpb24uY29tbWFuZEFyZ3VtZW50cykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBbaSwgYXJnXSBvZiBhY3Rpb24uY29tbWFuZEFyZ3VtZW50cy5lbnRyaWVzKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgJiYgbmVlZHNFdmFsdWF0aW9uKGFyZykpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXZhbHVhdGVkQXJnID0gZXZhbHVhdGVUZW1wbGF0ZShhcmcsIGNvbnRleHQpXG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGFuZ2VkLmNvbW1hbmRBcmd1bWVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZWQuY29tbWFuZEFyZ3VtZW50cy5wdXNoKGV2YWx1YXRlZEFyZylcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZWQuY29tbWFuZEFyZ3VtZW50cyA9IGFjdGlvbi5jb21tYW5kQXJndW1lbnRzLnNsaWNlKDAsIGkpLmNvbmNhdChldmFsdWF0ZWRBcmcpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZWQuY29tbWFuZEFyZ3VtZW50cykge1xuICAgICAgICAgICAgICAgICAgICBjaGFuZ2VkLmNvbW1hbmRBcmd1bWVudHMucHVzaChhcmcpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChhY3Rpb24udGl0bGUgJiYgbmVlZHNFdmFsdWF0aW9uKGFjdGlvbi50aXRsZSkpIHtcbiAgICAgICAgICAgIGNoYW5nZWQudGl0bGUgPSBldmFsdWF0ZVRlbXBsYXRlKGFjdGlvbi50aXRsZSwgY29udGV4dClcbiAgICAgICAgfVxuICAgICAgICBpZiAoYWN0aW9uLmNhdGVnb3J5ICYmIG5lZWRzRXZhbHVhdGlvbihhY3Rpb24uY2F0ZWdvcnkpKSB7XG4gICAgICAgICAgICBjaGFuZ2VkLmNhdGVnb3J5ID0gZXZhbHVhdGVUZW1wbGF0ZShhY3Rpb24uY2F0ZWdvcnksIGNvbnRleHQpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFjdGlvbi5kZXNjcmlwdGlvbiAmJiBuZWVkc0V2YWx1YXRpb24oYWN0aW9uLmRlc2NyaXB0aW9uKSkge1xuICAgICAgICAgICAgY2hhbmdlZC5kZXNjcmlwdGlvbiA9IGV2YWx1YXRlVGVtcGxhdGUoYWN0aW9uLmRlc2NyaXB0aW9uLCBjb250ZXh0KVxuICAgICAgICB9XG4gICAgICAgIGlmIChhY3Rpb24uaWNvblVSTCAmJiBuZWVkc0V2YWx1YXRpb24oYWN0aW9uLmljb25VUkwpKSB7XG4gICAgICAgICAgICBjaGFuZ2VkLmljb25VUkwgPSBldmFsdWF0ZVRlbXBsYXRlKGFjdGlvbi5pY29uVVJMLCBjb250ZXh0KVxuICAgICAgICB9XG4gICAgICAgIGlmIChhY3Rpb24uYWN0aW9uSXRlbSkge1xuICAgICAgICAgICAgY29uc3QgY2hhbmdlZEFjdGlvbkl0ZW06IFBhcnRpYWw8QWN0aW9uSXRlbT4gPSB7fVxuICAgICAgICAgICAgaWYgKGFjdGlvbi5hY3Rpb25JdGVtLmxhYmVsICYmIG5lZWRzRXZhbHVhdGlvbihhY3Rpb24uYWN0aW9uSXRlbS5sYWJlbCkpIHtcbiAgICAgICAgICAgICAgICBjaGFuZ2VkQWN0aW9uSXRlbS5sYWJlbCA9IGV2YWx1YXRlVGVtcGxhdGUoYWN0aW9uLmFjdGlvbkl0ZW0ubGFiZWwsIGNvbnRleHQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWN0aW9uLmFjdGlvbkl0ZW0uZGVzY3JpcHRpb24gJiYgbmVlZHNFdmFsdWF0aW9uKGFjdGlvbi5hY3Rpb25JdGVtLmRlc2NyaXB0aW9uKSkge1xuICAgICAgICAgICAgICAgIGNoYW5nZWRBY3Rpb25JdGVtLmRlc2NyaXB0aW9uID0gZXZhbHVhdGVUZW1wbGF0ZShhY3Rpb24uYWN0aW9uSXRlbS5kZXNjcmlwdGlvbiwgY29udGV4dClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhY3Rpb24uYWN0aW9uSXRlbS5pY29uVVJMICYmIG5lZWRzRXZhbHVhdGlvbihhY3Rpb24uYWN0aW9uSXRlbS5pY29uVVJMKSkge1xuICAgICAgICAgICAgICAgIGNoYW5nZWRBY3Rpb25JdGVtLmljb25VUkwgPSBldmFsdWF0ZVRlbXBsYXRlKGFjdGlvbi5hY3Rpb25JdGVtLmljb25VUkwsIGNvbnRleHQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWN0aW9uLmFjdGlvbkl0ZW0uaWNvbkRlc2NyaXB0aW9uICYmIG5lZWRzRXZhbHVhdGlvbihhY3Rpb24uYWN0aW9uSXRlbS5pY29uRGVzY3JpcHRpb24pKSB7XG4gICAgICAgICAgICAgICAgY2hhbmdlZEFjdGlvbkl0ZW0uaWNvbkRlc2NyaXB0aW9uID0gZXZhbHVhdGVUZW1wbGF0ZShhY3Rpb24uYWN0aW9uSXRlbS5pY29uRGVzY3JpcHRpb24sIGNvbnRleHQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoY2hhbmdlZEFjdGlvbkl0ZW0pLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgICAgIGNoYW5nZWQuYWN0aW9uSXRlbSA9IHsgLi4uYWN0aW9uLmFjdGlvbkl0ZW0sIC4uLmNoYW5nZWRBY3Rpb25JdGVtIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtb2RpZmllZCA9IE9iamVjdC5rZXlzKGNoYW5nZWQpLmxlbmd0aCAhPT0gMFxuICAgICAgICBldmFsdWF0ZWRBY3Rpb25zLnB1c2gobW9kaWZpZWQgPyB7IC4uLmFjdGlvbiwgLi4uY2hhbmdlZCB9IDogYWN0aW9uKVxuICAgIH1cbiAgICByZXR1cm4geyAuLi5jb250cmlidXRpb25zLCBhY3Rpb25zOiBldmFsdWF0ZWRBY3Rpb25zIH1cbn1cbiJdfQ==