import { BehaviorSubject, Subject, Subscription } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { createConnection } from '../protocol/jsonrpc2/connection';
import { BrowserConsoleTracer } from '../protocol/jsonrpc2/trace';
import { isEqual } from '../util';
import { ClientCodeEditor } from './api/codeEditor';
import { ClientCommands } from './api/commands';
import { ClientConfiguration } from './api/configuration';
import { ClientContext } from './api/context';
import { ClientDocuments } from './api/documents';
import { ClientLanguageFeatures } from './api/languageFeatures';
import { Search } from './api/search';
import { ClientViews } from './api/views';
import { ClientWindows } from './api/windows';
import { applyContextUpdate, EMPTY_CONTEXT } from './context/context';
import { EMPTY_ENVIRONMENT } from './environment';
import { Registries } from './registries';
/**
 * The controller for the environment.
 *
 * @template X extension type
 * @template C configuration cascade type
 */
export class Controller {
    constructor(options) {
        this.options = options;
        this._environment = new BehaviorSubject(EMPTY_ENVIRONMENT);
        /** The environment. */
        this.environment = this._environment;
        this._clientEntries = new BehaviorSubject([]);
        this.subscriptions = new Subscription();
        this._logMessages = new Subject();
        this._showMessages = new Subject();
        this._showMessageRequests = new Subject();
        this._showInputs = new Subject();
        this._configurationUpdates = new Subject();
        /** Log messages from extensions. */
        this.logMessages = this._logMessages;
        /** Messages from extensions intended for display to the user. */
        this.showMessages = this._showMessages;
        /** Messages from extensions requesting the user to select an action. */
        this.showMessageRequests = this._showMessageRequests;
        /** Messages from extensions requesting text input from the user. */
        this.showInputs = this._showInputs;
        /** Configuration updates from extensions. */
        this.configurationUpdates = this._configurationUpdates;
        /**
         * Detect when setEnvironment is called within a setEnvironment call, which probably means there is a bug.
         */
        this.inSetEnvironment = false;
        this.subscriptions.add(() => {
            for (const c of this._clientEntries.value) {
                c.subscription.unsubscribe();
            }
        });
        this.registries = new Registries(this.environment);
    }
    /** An observable that emits whenever the set of clients managed by this controller changes. */
    get clientEntries() {
        return this._clientEntries;
    }
    setEnvironment(nextEnvironment) {
        if (this.inSetEnvironment) {
            throw new Error('setEnvironment may not be called recursively');
        }
        this.inSetEnvironment = true;
        if (this.options.environmentFilter) {
            nextEnvironment = this.options.environmentFilter(nextEnvironment);
        }
        // External consumers don't see context, and their setEnvironment args lack context.
        if (nextEnvironment.context === EMPTY_CONTEXT) {
            nextEnvironment = Object.assign({}, nextEnvironment, { context: this._environment.value.context });
        }
        if (isEqual(this._environment.value, nextEnvironment)) {
            this.inSetEnvironment = false;
            return; // no change
        }
        this._environment.next(nextEnvironment);
        this.onEnvironmentChange();
        this.inSetEnvironment = false;
    }
    onEnvironmentChange() {
        const environment = this._environment.value; // new environment
        // Diff clients.
        const newClients = computeClients(environment);
        const nextClients = [];
        const unusedClients = [];
        for (const oldClient of this._clientEntries.value) {
            const newIndex = newClients.findIndex(newClient => isEqual(oldClient.key, newClient));
            if (newIndex === -1) {
                // Client is no longer needed.
                unusedClients.push(oldClient);
            }
            else {
                // Client already exists. Settings may have changed, but ConfigurationFeature is responsible for
                // notifying the server of configuration changes.
                newClients.splice(newIndex, 1);
                nextClients.push(oldClient);
            }
        }
        // Remove clients that are no longer in use.
        for (const unusedClient of unusedClients) {
            unusedClient.subscription.unsubscribe();
        }
        // Create new clients.
        for (const key of newClients) {
            // Find the extension that this client is for.
            const extension = environment.extensions.find(x => x.id === key.id);
            if (!extension) {
                throw new Error(`extension not found: ${key.id}`);
            }
            // Construct client.
            const clientOptions = this.options.clientOptions(key, extension);
            const subscription = new Subscription();
            const extensionConnection = {
                key,
                subscription,
                connection: Promise.resolve(clientOptions.createMessageTransports()).then(transports => {
                    const connection = createConnection(transports);
                    subscription.add(connection);
                    connection.listen();
                    connection.onRequest('ping', () => 'pong');
                    this.registerClientFeatures(connection, subscription, this.environment.pipe(map(({ configuration }) => configuration), distinctUntilChanged()));
                    return connection;
                }),
            };
            nextClients.push(extensionConnection);
        }
        this._clientEntries.next(nextClients);
    }
    registerClientFeatures(client, subscription, configuration) {
        subscription.add(new ClientConfiguration(client, configuration, (params) => new Promise(resolve => this._configurationUpdates.next(Object.assign({}, params, { resolve })))));
        subscription.add(new ClientContext(client, (updates) => 
        // Set environment manually, not via Controller#setEnvironment, to avoid recursive setEnvironment calls
        // (when this callback is called during setEnvironment's teardown of unused clients).
        this._environment.next(Object.assign({}, this._environment.value, { context: applyContextUpdate(this._environment.value.context, updates) }))));
        subscription.add(new ClientWindows(client, this.environment.pipe(map(({ visibleTextDocuments }) => visibleTextDocuments), distinctUntilChanged()), (params) => this._showMessages.next(Object.assign({}, params)), (params) => new Promise(resolve => {
            this._showMessageRequests.next(Object.assign({}, params, { resolve }));
        }), (params) => new Promise(resolve => {
            this._showInputs.next(Object.assign({}, params, { resolve }));
        })));
        subscription.add(new ClientViews(client, this.registries.views));
        subscription.add(new ClientCodeEditor(client, this.registries.textDocumentDecoration));
        subscription.add(new ClientDocuments(client, this.environment.pipe(map(({ visibleTextDocuments }) => visibleTextDocuments), distinctUntilChanged())));
        subscription.add(new ClientLanguageFeatures(client, this.registries.textDocumentHover, this.registries.textDocumentDefinition, this.registries.textDocumentTypeDefinition, this.registries.textDocumentImplementation, this.registries.textDocumentReferences));
        subscription.add(new Search(client, this.registries.queryTransformer));
        subscription.add(new ClientCommands(client, this.registries.commands));
    }
    set trace(value) {
        for (const client of this._clientEntries.value) {
            client.connection
                .then(connection => {
                connection.trace(value, new BrowserConsoleTracer(client.key.id));
            })
                .catch(() => void 0);
        }
    }
    unsubscribe() {
        this.subscriptions.unsubscribe();
    }
}
function computeClients(environment) {
    const clients = [];
    if (!environment.extensions) {
        return clients;
    }
    for (const x of environment.extensions) {
        clients.push({ id: x.id });
    }
    return clients;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiJzcmMvIiwic291cmNlcyI6WyJjbGllbnQvY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFjLE9BQU8sRUFBRSxZQUFZLEVBQWtCLE1BQU0sTUFBTSxDQUFBO0FBQ3pGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQVcxRCxPQUFPLEVBQWMsZ0JBQWdCLEVBQXFCLE1BQU0saUNBQWlDLENBQUE7QUFDakcsT0FBTyxFQUFFLG9CQUFvQixFQUFTLE1BQU0sNEJBQTRCLENBQUE7QUFDeEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUNqQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUNuRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDL0MsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUJBQXFCLENBQUE7QUFDekQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQTtBQUM3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFDakQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFDL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQTtBQUNyQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFBO0FBQ3pDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDN0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBQ3JFLE9BQU8sRUFBRSxpQkFBaUIsRUFBZSxNQUFNLGVBQWUsQ0FBQTtBQUU5RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBNEN6Qzs7Ozs7R0FL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aUJBQ1osSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUNmLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksb0JBQW9CLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1lBQ3BFLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtTQUMzQjtJQUNMLENBQUM7SUFFTSxXQUFXO1FBQ2QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUNwQyxDQUFDO0NBQ0o7QUFFRCxTQUFTLGNBQWMsQ0FDbkIsV0FBb0Q7SUFFcEQsTUFBTSxPQUFPLEdBQTZCLEVBQUUsQ0FBQTtJQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRTtRQUN6QixPQUFPLE9BQU8sQ0FBQTtLQUNqQjtJQUNELEtBQUssTUFBTSxDQUFDLElBQUksV0FBVyxDQUFDLFVBQVUsRUFBRTtRQUNwQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0tBQzdCO0lBQ0QsT0FBTyxPQUFPLENBQUE7QUFDbEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgU3Vic2NyaXB0aW9uLCBVbnN1YnNjcmliYWJsZSB9IGZyb20gJ3J4anMnXG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnXG5pbXBvcnQgeyBDb250ZXh0VmFsdWVzIH0gZnJvbSAnc291cmNlZ3JhcGgnXG5pbXBvcnQge1xuICAgIENvbmZpZ3VyYXRpb25DYXNjYWRlLFxuICAgIENvbmZpZ3VyYXRpb25VcGRhdGVQYXJhbXMsXG4gICAgTG9nTWVzc2FnZVBhcmFtcyxcbiAgICBNZXNzYWdlQWN0aW9uSXRlbSxcbiAgICBTaG93SW5wdXRQYXJhbXMsXG4gICAgU2hvd01lc3NhZ2VQYXJhbXMsXG4gICAgU2hvd01lc3NhZ2VSZXF1ZXN0UGFyYW1zLFxufSBmcm9tICcuLi9wcm90b2NvbCdcbmltcG9ydCB7IENvbm5lY3Rpb24sIGNyZWF0ZUNvbm5lY3Rpb24sIE1lc3NhZ2VUcmFuc3BvcnRzIH0gZnJvbSAnLi4vcHJvdG9jb2wvanNvbnJwYzIvY29ubmVjdGlvbidcbmltcG9ydCB7IEJyb3dzZXJDb25zb2xlVHJhY2VyLCBUcmFjZSB9IGZyb20gJy4uL3Byb3RvY29sL2pzb25ycGMyL3RyYWNlJ1xuaW1wb3J0IHsgaXNFcXVhbCB9IGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBDbGllbnRDb2RlRWRpdG9yIH0gZnJvbSAnLi9hcGkvY29kZUVkaXRvcidcbmltcG9ydCB7IENsaWVudENvbW1hbmRzIH0gZnJvbSAnLi9hcGkvY29tbWFuZHMnXG5pbXBvcnQgeyBDbGllbnRDb25maWd1cmF0aW9uIH0gZnJvbSAnLi9hcGkvY29uZmlndXJhdGlvbidcbmltcG9ydCB7IENsaWVudENvbnRleHQgfSBmcm9tICcuL2FwaS9jb250ZXh0J1xuaW1wb3J0IHsgQ2xpZW50RG9jdW1lbnRzIH0gZnJvbSAnLi9hcGkvZG9jdW1lbnRzJ1xuaW1wb3J0IHsgQ2xpZW50TGFuZ3VhZ2VGZWF0dXJlcyB9IGZyb20gJy4vYXBpL2xhbmd1YWdlRmVhdHVyZXMnXG5pbXBvcnQgeyBTZWFyY2ggfSBmcm9tICcuL2FwaS9zZWFyY2gnXG5pbXBvcnQgeyBDbGllbnRWaWV3cyB9IGZyb20gJy4vYXBpL3ZpZXdzJ1xuaW1wb3J0IHsgQ2xpZW50V2luZG93cyB9IGZyb20gJy4vYXBpL3dpbmRvd3MnXG5pbXBvcnQgeyBhcHBseUNvbnRleHRVcGRhdGUsIEVNUFRZX0NPTlRFWFQgfSBmcm9tICcuL2NvbnRleHQvY29udGV4dCdcbmltcG9ydCB7IEVNUFRZX0VOVklST05NRU5ULCBFbnZpcm9ubWVudCB9IGZyb20gJy4vZW52aXJvbm1lbnQnXG5pbXBvcnQgeyBFeHRlbnNpb24gfSBmcm9tICcuL2V4dGVuc2lvbidcbmltcG9ydCB7IFJlZ2lzdHJpZXMgfSBmcm9tICcuL3JlZ2lzdHJpZXMnXG5cbi8qKiBUaGUgbWluaW1hbCB1bmlxdWUgaWRlbnRpZmllciBmb3IgYSBjbGllbnQuICovXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVuc2lvbkNvbm5lY3Rpb25LZXkge1xuICAgIC8qKiBUaGUgZXh0ZW5zaW9uIElELiAqL1xuICAgIGlkOiBzdHJpbmdcbn1cblxuLyoqIEEgY29ubmVjdGlvbiB0byBhbiBleHRlbnNpb24gYW5kIGl0cyB1bmlxdWUgaWRlbnRpZmllciAoa2V5KS4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZW5zaW9uQ29ubmVjdGlvbiB7XG4gICAgY29ubmVjdGlvbjogUHJvbWlzZTxDb25uZWN0aW9uPlxuICAgIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uXG4gICAga2V5OiBFeHRlbnNpb25Db25uZWN0aW9uS2V5XG59XG5cbmludGVyZmFjZSBQcm9taXNlQ2FsbGJhY2s8VD4ge1xuICAgIHJlc29sdmU6IChwOiBUIHwgUHJvbWlzZTxUPikgPT4gdm9pZFxufVxuXG50eXBlIFNob3dNZXNzYWdlUmVxdWVzdCA9IFNob3dNZXNzYWdlUmVxdWVzdFBhcmFtcyAmIFByb21pc2VDYWxsYmFjazxNZXNzYWdlQWN0aW9uSXRlbSB8IG51bGw+XG5cbnR5cGUgU2hvd0lucHV0UmVxdWVzdCA9IFNob3dJbnB1dFBhcmFtcyAmIFByb21pc2VDYWxsYmFjazxzdHJpbmcgfCBudWxsPlxuXG5leHBvcnQgdHlwZSBDb25maWd1cmF0aW9uVXBkYXRlID0gQ29uZmlndXJhdGlvblVwZGF0ZVBhcmFtcyAmIFByb21pc2VDYWxsYmFjazx2b2lkPlxuXG4vKipcbiAqIE9wdGlvbnMgZm9yIGNyZWF0aW5nIHRoZSBjb250cm9sbGVyLlxuICpcbiAqIEB0ZW1wbGF0ZSBYIGV4dGVuc2lvbiB0eXBlXG4gKiBAdGVtcGxhdGUgQyBjb25maWd1cmF0aW9uIGNhc2NhZGUgdHlwZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbnRyb2xsZXJPcHRpb25zPFggZXh0ZW5kcyBFeHRlbnNpb24sIEMgZXh0ZW5kcyBDb25maWd1cmF0aW9uQ2FzY2FkZT4ge1xuICAgIC8qKiBSZXR1cm5zIGFkZGl0aW9uYWwgb3B0aW9ucyB0byB1c2Ugd2hlbiBjcmVhdGluZyBhIGNsaWVudC4gKi9cbiAgICBjbGllbnRPcHRpb25zOiAoXG4gICAgICAgIGtleTogRXh0ZW5zaW9uQ29ubmVjdGlvbktleSxcbiAgICAgICAgZXh0ZW5zaW9uOiBYXG4gICAgKSA9PiB7IGNyZWF0ZU1lc3NhZ2VUcmFuc3BvcnRzOiAoKSA9PiBNZXNzYWdlVHJhbnNwb3J0cyB8IFByb21pc2U8TWVzc2FnZVRyYW5zcG9ydHM+IH1cblxuICAgIC8qKlxuICAgICAqIENhbGxlZCBiZWZvcmUgYXBwbHlpbmcgdGhlIG5leHQgZW52aXJvbm1lbnQgaW4gQ29udHJvbGxlciNzZXRFbnZpcm9ubWVudC4gSXQgc2hvdWxkIGhhdmUgbm8gc2lkZSBlZmZlY3RzLlxuICAgICAqL1xuICAgIGVudmlyb25tZW50RmlsdGVyPzogKG5leHRFbnZpcm9ubWVudDogRW52aXJvbm1lbnQ8WCwgQz4pID0+IEVudmlyb25tZW50PFgsIEM+XG59XG5cbi8qKlxuICogVGhlIGNvbnRyb2xsZXIgZm9yIHRoZSBlbnZpcm9ubWVudC5cbiAqXG4gKiBAdGVtcGxhdGUgWCBleHRlbnNpb24gdHlwZVxuICogQHRlbXBsYXRlIEMgY29uZmlndXJhdGlvbiBjYXNjYWRlIHR5cGVcbiAqL1xuZXhwb3J0IGNsYXNzIENvbnRyb2xsZXI8WCBleHRlbmRzIEV4dGVuc2lvbiwgQyBleHRlbmRzIENvbmZpZ3VyYXRpb25DYXNjYWRlPiBpbXBsZW1lbnRzIFVuc3Vic2NyaWJhYmxlIHtcbiAgICBwcml2YXRlIF9lbnZpcm9ubWVudCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RW52aXJvbm1lbnQ8WCwgQz4+KEVNUFRZX0VOVklST05NRU5UKVxuXG4gICAgLyoqIFRoZSBlbnZpcm9ubWVudC4gKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgZW52aXJvbm1lbnQ6IE9ic2VydmFibGU8RW52aXJvbm1lbnQ8WCwgQz4+ID0gdGhpcy5fZW52aXJvbm1lbnRcblxuICAgIHByaXZhdGUgX2NsaWVudEVudHJpZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEV4dGVuc2lvbkNvbm5lY3Rpb25bXT4oW10pXG5cbiAgICAvKiogQW4gb2JzZXJ2YWJsZSB0aGF0IGVtaXRzIHdoZW5ldmVyIHRoZSBzZXQgb2YgY2xpZW50cyBtYW5hZ2VkIGJ5IHRoaXMgY29udHJvbGxlciBjaGFuZ2VzLiAqL1xuICAgIHB1YmxpYyBnZXQgY2xpZW50RW50cmllcygpOiBPYnNlcnZhYmxlPEV4dGVuc2lvbkNvbm5lY3Rpb25bXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fY2xpZW50RW50cmllc1xuICAgIH1cblxuICAgIHByaXZhdGUgc3Vic2NyaXB0aW9ucyA9IG5ldyBTdWJzY3JpcHRpb24oKVxuXG4gICAgLyoqIFRoZSByZWdpc3RyaWVzIGZvciB2YXJpb3VzIHByb3ZpZGVycyB0aGF0IGV4cG9zZSBleHRlbnNpb24gZnVuY3Rpb25hbGl0eS4gKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgcmVnaXN0cmllczogUmVnaXN0cmllczxYLCBDPlxuXG4gICAgcHJpdmF0ZSByZWFkb25seSBfbG9nTWVzc2FnZXMgPSBuZXcgU3ViamVjdDxMb2dNZXNzYWdlUGFyYW1zPigpXG4gICAgcHJpdmF0ZSByZWFkb25seSBfc2hvd01lc3NhZ2VzID0gbmV3IFN1YmplY3Q8U2hvd01lc3NhZ2VQYXJhbXM+KClcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9zaG93TWVzc2FnZVJlcXVlc3RzID0gbmV3IFN1YmplY3Q8U2hvd01lc3NhZ2VSZXF1ZXN0PigpXG4gICAgcHJpdmF0ZSByZWFkb25seSBfc2hvd0lucHV0cyA9IG5ldyBTdWJqZWN0PFNob3dJbnB1dFJlcXVlc3Q+KClcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9jb25maWd1cmF0aW9uVXBkYXRlcyA9IG5ldyBTdWJqZWN0PENvbmZpZ3VyYXRpb25VcGRhdGU+KClcblxuICAgIC8qKiBMb2cgbWVzc2FnZXMgZnJvbSBleHRlbnNpb25zLiAqL1xuICAgIHB1YmxpYyByZWFkb25seSBsb2dNZXNzYWdlczogT2JzZXJ2YWJsZTxMb2dNZXNzYWdlUGFyYW1zPiA9IHRoaXMuX2xvZ01lc3NhZ2VzXG5cbiAgICAvKiogTWVzc2FnZXMgZnJvbSBleHRlbnNpb25zIGludGVuZGVkIGZvciBkaXNwbGF5IHRvIHRoZSB1c2VyLiAqL1xuICAgIHB1YmxpYyByZWFkb25seSBzaG93TWVzc2FnZXM6IE9ic2VydmFibGU8U2hvd01lc3NhZ2VQYXJhbXM+ID0gdGhpcy5fc2hvd01lc3NhZ2VzXG5cbiAgICAvKiogTWVzc2FnZXMgZnJvbSBleHRlbnNpb25zIHJlcXVlc3RpbmcgdGhlIHVzZXIgdG8gc2VsZWN0IGFuIGFjdGlvbi4gKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgc2hvd01lc3NhZ2VSZXF1ZXN0czogT2JzZXJ2YWJsZTxTaG93TWVzc2FnZVJlcXVlc3Q+ID0gdGhpcy5fc2hvd01lc3NhZ2VSZXF1ZXN0c1xuXG4gICAgLyoqIE1lc3NhZ2VzIGZyb20gZXh0ZW5zaW9ucyByZXF1ZXN0aW5nIHRleHQgaW5wdXQgZnJvbSB0aGUgdXNlci4gKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgc2hvd0lucHV0czogT2JzZXJ2YWJsZTxTaG93SW5wdXRSZXF1ZXN0PiA9IHRoaXMuX3Nob3dJbnB1dHNcblxuICAgIC8qKiBDb25maWd1cmF0aW9uIHVwZGF0ZXMgZnJvbSBleHRlbnNpb25zLiAqL1xuICAgIHB1YmxpYyByZWFkb25seSBjb25maWd1cmF0aW9uVXBkYXRlczogT2JzZXJ2YWJsZTxDb25maWd1cmF0aW9uVXBkYXRlPiA9IHRoaXMuX2NvbmZpZ3VyYXRpb25VcGRhdGVzXG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdGlvbnM6IENvbnRyb2xsZXJPcHRpb25zPFgsIEM+KSB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoKCkgPT4ge1xuICAgICAgICAgICAgZm9yIChjb25zdCBjIG9mIHRoaXMuX2NsaWVudEVudHJpZXMudmFsdWUpIHtcbiAgICAgICAgICAgICAgICBjLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5yZWdpc3RyaWVzID0gbmV3IFJlZ2lzdHJpZXM8WCwgQz4odGhpcy5lbnZpcm9ubWVudClcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZXRlY3Qgd2hlbiBzZXRFbnZpcm9ubWVudCBpcyBjYWxsZWQgd2l0aGluIGEgc2V0RW52aXJvbm1lbnQgY2FsbCwgd2hpY2ggcHJvYmFibHkgbWVhbnMgdGhlcmUgaXMgYSBidWcuXG4gICAgICovXG4gICAgcHJpdmF0ZSBpblNldEVudmlyb25tZW50ID0gZmFsc2VcblxuICAgIHB1YmxpYyBzZXRFbnZpcm9ubWVudChuZXh0RW52aXJvbm1lbnQ6IEVudmlyb25tZW50PFgsIEM+KTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmluU2V0RW52aXJvbm1lbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc2V0RW52aXJvbm1lbnQgbWF5IG5vdCBiZSBjYWxsZWQgcmVjdXJzaXZlbHknKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5TZXRFbnZpcm9ubWVudCA9IHRydWVcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmVudmlyb25tZW50RmlsdGVyKSB7XG4gICAgICAgICAgICBuZXh0RW52aXJvbm1lbnQgPSB0aGlzLm9wdGlvbnMuZW52aXJvbm1lbnRGaWx0ZXIobmV4dEVudmlyb25tZW50KVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gRXh0ZXJuYWwgY29uc3VtZXJzIGRvbid0IHNlZSBjb250ZXh0LCBhbmQgdGhlaXIgc2V0RW52aXJvbm1lbnQgYXJncyBsYWNrIGNvbnRleHQuXG4gICAgICAgIGlmIChuZXh0RW52aXJvbm1lbnQuY29udGV4dCA9PT0gRU1QVFlfQ09OVEVYVCkge1xuICAgICAgICAgICAgbmV4dEVudmlyb25tZW50ID0geyAuLi5uZXh0RW52aXJvbm1lbnQsIGNvbnRleHQ6IHRoaXMuX2Vudmlyb25tZW50LnZhbHVlLmNvbnRleHQgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlzRXF1YWwodGhpcy5fZW52aXJvbm1lbnQudmFsdWUsIG5leHRFbnZpcm9ubWVudCkpIHtcbiAgICAgICAgICAgIHRoaXMuaW5TZXRFbnZpcm9ubWVudCA9IGZhbHNlXG4gICAgICAgICAgICByZXR1cm4gLy8gbm8gY2hhbmdlXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9lbnZpcm9ubWVudC5uZXh0KG5leHRFbnZpcm9ubWVudClcbiAgICAgICAgdGhpcy5vbkVudmlyb25tZW50Q2hhbmdlKClcbiAgICAgICAgdGhpcy5pblNldEVudmlyb25tZW50ID0gZmFsc2VcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRW52aXJvbm1lbnRDaGFuZ2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGVudmlyb25tZW50ID0gdGhpcy5fZW52aXJvbm1lbnQudmFsdWUgLy8gbmV3IGVudmlyb25tZW50XG5cbiAgICAgICAgLy8gRGlmZiBjbGllbnRzLlxuICAgICAgICBjb25zdCBuZXdDbGllbnRzID0gY29tcHV0ZUNsaWVudHMoZW52aXJvbm1lbnQpXG4gICAgICAgIGNvbnN0IG5leHRDbGllbnRzOiBFeHRlbnNpb25Db25uZWN0aW9uW10gPSBbXVxuICAgICAgICBjb25zdCB1bnVzZWRDbGllbnRzOiBFeHRlbnNpb25Db25uZWN0aW9uW10gPSBbXVxuICAgICAgICBmb3IgKGNvbnN0IG9sZENsaWVudCBvZiB0aGlzLl9jbGllbnRFbnRyaWVzLnZhbHVlKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IG5ld0NsaWVudHMuZmluZEluZGV4KG5ld0NsaWVudCA9PiBpc0VxdWFsKG9sZENsaWVudC5rZXksIG5ld0NsaWVudCkpXG4gICAgICAgICAgICBpZiAobmV3SW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgLy8gQ2xpZW50IGlzIG5vIGxvbmdlciBuZWVkZWQuXG4gICAgICAgICAgICAgICAgdW51c2VkQ2xpZW50cy5wdXNoKG9sZENsaWVudClcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gQ2xpZW50IGFscmVhZHkgZXhpc3RzLiBTZXR0aW5ncyBtYXkgaGF2ZSBjaGFuZ2VkLCBidXQgQ29uZmlndXJhdGlvbkZlYXR1cmUgaXMgcmVzcG9uc2libGUgZm9yXG4gICAgICAgICAgICAgICAgLy8gbm90aWZ5aW5nIHRoZSBzZXJ2ZXIgb2YgY29uZmlndXJhdGlvbiBjaGFuZ2VzLlxuICAgICAgICAgICAgICAgIG5ld0NsaWVudHMuc3BsaWNlKG5ld0luZGV4LCAxKVxuICAgICAgICAgICAgICAgIG5leHRDbGllbnRzLnB1c2gob2xkQ2xpZW50KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIFJlbW92ZSBjbGllbnRzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB1c2UuXG4gICAgICAgIGZvciAoY29uc3QgdW51c2VkQ2xpZW50IG9mIHVudXNlZENsaWVudHMpIHtcbiAgICAgICAgICAgIHVudXNlZENsaWVudC5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgICAgICB9XG4gICAgICAgIC8vIENyZWF0ZSBuZXcgY2xpZW50cy5cbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgbmV3Q2xpZW50cykge1xuICAgICAgICAgICAgLy8gRmluZCB0aGUgZXh0ZW5zaW9uIHRoYXQgdGhpcyBjbGllbnQgaXMgZm9yLlxuICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uID0gZW52aXJvbm1lbnQuZXh0ZW5zaW9ucyEuZmluZCh4ID0+IHguaWQgPT09IGtleS5pZClcbiAgICAgICAgICAgIGlmICghZXh0ZW5zaW9uKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBleHRlbnNpb24gbm90IGZvdW5kOiAke2tleS5pZH1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBDb25zdHJ1Y3QgY2xpZW50LlxuICAgICAgICAgICAgY29uc3QgY2xpZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucy5jbGllbnRPcHRpb25zKGtleSwgZXh0ZW5zaW9uKVxuICAgICAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpXG4gICAgICAgICAgICBjb25zdCBleHRlbnNpb25Db25uZWN0aW9uOiBFeHRlbnNpb25Db25uZWN0aW9uID0ge1xuICAgICAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbjogUHJvbWlzZS5yZXNvbHZlKGNsaWVudE9wdGlvbnMuY3JlYXRlTWVzc2FnZVRyYW5zcG9ydHMoKSkudGhlbih0cmFuc3BvcnRzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGNyZWF0ZUNvbm5lY3Rpb24odHJhbnNwb3J0cylcbiAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLmFkZChjb25uZWN0aW9uKVxuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmxpc3RlbigpXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ub25SZXF1ZXN0KCdwaW5nJywgKCkgPT4gJ3BvbmcnKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyQ2xpZW50RmVhdHVyZXMoXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnZpcm9ubWVudC5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcCgoeyBjb25maWd1cmF0aW9uIH0pID0+IGNvbmZpZ3VyYXRpb24pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29ubmVjdGlvblxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBuZXh0Q2xpZW50cy5wdXNoKGV4dGVuc2lvbkNvbm5lY3Rpb24pXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fY2xpZW50RW50cmllcy5uZXh0KG5leHRDbGllbnRzKVxuICAgIH1cblxuICAgIHByaXZhdGUgcmVnaXN0ZXJDbGllbnRGZWF0dXJlcyhjbGllbnQ6IENvbm5lY3Rpb24sIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uLCBjb25maWd1cmF0aW9uOiBPYnNlcnZhYmxlPEM+KTogdm9pZCB7XG4gICAgICAgIHN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgICAgICBuZXcgQ2xpZW50Q29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBjbGllbnQsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAocGFyYW1zOiBDb25maWd1cmF0aW9uVXBkYXRlUGFyYW1zKSA9PlxuICAgICAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZTx2b2lkPihyZXNvbHZlID0+IHRoaXMuX2NvbmZpZ3VyYXRpb25VcGRhdGVzLm5leHQoeyAuLi5wYXJhbXMsIHJlc29sdmUgfSkpXG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgICAgIG5ldyBDbGllbnRDb250ZXh0KGNsaWVudCwgKHVwZGF0ZXM6IENvbnRleHRWYWx1ZXMpID0+XG4gICAgICAgICAgICAgICAgLy8gU2V0IGVudmlyb25tZW50IG1hbnVhbGx5LCBub3QgdmlhIENvbnRyb2xsZXIjc2V0RW52aXJvbm1lbnQsIHRvIGF2b2lkIHJlY3Vyc2l2ZSBzZXRFbnZpcm9ubWVudCBjYWxsc1xuICAgICAgICAgICAgICAgIC8vICh3aGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIGR1cmluZyBzZXRFbnZpcm9ubWVudCdzIHRlYXJkb3duIG9mIHVudXNlZCBjbGllbnRzKS5cbiAgICAgICAgICAgICAgICB0aGlzLl9lbnZpcm9ubWVudC5uZXh0KHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5fZW52aXJvbm1lbnQudmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IGFwcGx5Q29udGV4dFVwZGF0ZSh0aGlzLl9lbnZpcm9ubWVudC52YWx1ZS5jb250ZXh0LCB1cGRhdGVzKSxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgIHN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgICAgICBuZXcgQ2xpZW50V2luZG93cyhcbiAgICAgICAgICAgICAgICBjbGllbnQsXG4gICAgICAgICAgICAgICAgdGhpcy5lbnZpcm9ubWVudC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoKHsgdmlzaWJsZVRleHREb2N1bWVudHMgfSkgPT4gdmlzaWJsZVRleHREb2N1bWVudHMpLFxuICAgICAgICAgICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAocGFyYW1zOiBTaG93TWVzc2FnZVBhcmFtcykgPT4gdGhpcy5fc2hvd01lc3NhZ2VzLm5leHQoeyAuLi5wYXJhbXMgfSksXG4gICAgICAgICAgICAgICAgKHBhcmFtczogU2hvd01lc3NhZ2VSZXF1ZXN0UGFyYW1zKSA9PlxuICAgICAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZTxNZXNzYWdlQWN0aW9uSXRlbSB8IG51bGw+KHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd01lc3NhZ2VSZXF1ZXN0cy5uZXh0KHsgLi4ucGFyYW1zLCByZXNvbHZlIH0pXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIChwYXJhbXM6IFNob3dJbnB1dFBhcmFtcykgPT5cbiAgICAgICAgICAgICAgICAgICAgbmV3IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93SW5wdXRzLm5leHQoeyAuLi5wYXJhbXMsIHJlc29sdmUgfSlcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgICBzdWJzY3JpcHRpb24uYWRkKG5ldyBDbGllbnRWaWV3cyhjbGllbnQsIHRoaXMucmVnaXN0cmllcy52aWV3cykpXG4gICAgICAgIHN1YnNjcmlwdGlvbi5hZGQobmV3IENsaWVudENvZGVFZGl0b3IoY2xpZW50LCB0aGlzLnJlZ2lzdHJpZXMudGV4dERvY3VtZW50RGVjb3JhdGlvbikpXG4gICAgICAgIHN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgICAgICBuZXcgQ2xpZW50RG9jdW1lbnRzKFxuICAgICAgICAgICAgICAgIGNsaWVudCxcbiAgICAgICAgICAgICAgICB0aGlzLmVudmlyb25tZW50LnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1hcCgoeyB2aXNpYmxlVGV4dERvY3VtZW50cyB9KSA9PiB2aXNpYmxlVGV4dERvY3VtZW50cyksXG4gICAgICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgICAgIG5ldyBDbGllbnRMYW5ndWFnZUZlYXR1cmVzKFxuICAgICAgICAgICAgICAgIGNsaWVudCxcbiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJpZXMudGV4dERvY3VtZW50SG92ZXIsXG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyaWVzLnRleHREb2N1bWVudERlZmluaXRpb24sXG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyaWVzLnRleHREb2N1bWVudFR5cGVEZWZpbml0aW9uLFxuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cmllcy50ZXh0RG9jdW1lbnRJbXBsZW1lbnRhdGlvbixcbiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJpZXMudGV4dERvY3VtZW50UmVmZXJlbmNlc1xuICAgICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgIHN1YnNjcmlwdGlvbi5hZGQobmV3IFNlYXJjaChjbGllbnQsIHRoaXMucmVnaXN0cmllcy5xdWVyeVRyYW5zZm9ybWVyKSlcbiAgICAgICAgc3Vic2NyaXB0aW9uLmFkZChuZXcgQ2xpZW50Q29tbWFuZHMoY2xpZW50LCB0aGlzLnJlZ2lzdHJpZXMuY29tbWFuZHMpKVxuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgdHJhY2UodmFsdWU6IFRyYWNlKSB7XG4gICAgICAgIGZvciAoY29uc3QgY2xpZW50IG9mIHRoaXMuX2NsaWVudEVudHJpZXMudmFsdWUpIHtcbiAgICAgICAgICAgIGNsaWVudC5jb25uZWN0aW9uXG4gICAgICAgICAgICAgICAgLnRoZW4oY29ubmVjdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24udHJhY2UodmFsdWUsIG5ldyBCcm93c2VyQ29uc29sZVRyYWNlcihjbGllbnQua2V5LmlkKSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB2b2lkIDApXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgdW5zdWJzY3JpYmUoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpXG4gICAgfVxufVxuXG5mdW5jdGlvbiBjb21wdXRlQ2xpZW50czxYIGV4dGVuZHMgRXh0ZW5zaW9uPihcbiAgICBlbnZpcm9ubWVudDogUGljazxFbnZpcm9ubWVudDxYLCBhbnk+LCAnZXh0ZW5zaW9ucyc+XG4pOiBFeHRlbnNpb25Db25uZWN0aW9uS2V5W10ge1xuICAgIGNvbnN0IGNsaWVudHM6IEV4dGVuc2lvbkNvbm5lY3Rpb25LZXlbXSA9IFtdXG4gICAgaWYgKCFlbnZpcm9ubWVudC5leHRlbnNpb25zKSB7XG4gICAgICAgIHJldHVybiBjbGllbnRzXG4gICAgfVxuICAgIGZvciAoY29uc3QgeCBvZiBlbnZpcm9ubWVudC5leHRlbnNpb25zKSB7XG4gICAgICAgIGNsaWVudHMucHVzaCh7IGlkOiB4LmlkIH0pXG4gICAgfVxuICAgIHJldHVybiBjbGllbnRzXG59XG4iXX0=