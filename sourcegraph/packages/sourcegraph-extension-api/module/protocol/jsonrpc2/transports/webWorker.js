import { AbstractMessageReader, AbstractMessageWriter } from '../transport';
class WebWorkerMessageReader extends AbstractMessageReader {
    constructor(worker) {
        super();
        this.worker = worker;
        this.pending = [];
        this.callback = null;
        worker.addEventListener('message', (e) => {
            try {
                this.processMessage(e);
            }
            catch (err) {
                this.fireError(err);
            }
        });
        worker.addEventListener('error', err => {
            this.fireError(err);
            terminateWorker(worker);
            this.fireClose();
        });
    }
    processMessage(e) {
        const message = e.data;
        if (this.callback) {
            this.callback(message);
        }
        else {
            this.pending.push(message);
        }
    }
    listen(callback) {
        if (this.callback) {
            throw new Error('callback is already set');
        }
        this.callback = callback;
        while (this.pending.length !== 0) {
            callback(this.pending.pop());
        }
    }
    unsubscribe() {
        super.unsubscribe();
        this.callback = null;
        terminateWorker(this.worker);
    }
}
class WebWorkerMessageWriter extends AbstractMessageWriter {
    constructor(worker) {
        super();
        this.worker = worker;
        this.errorCount = 0;
    }
    write(message) {
        try {
            this.worker.postMessage(message);
        }
        catch (error) {
            this.fireError(error, message, ++this.errorCount);
        }
    }
    unsubscribe() {
        super.unsubscribe();
        terminateWorker(this.worker);
    }
}
function terminateWorker(worker) {
    if (worker.terminate) {
        worker.terminate(); // in window (worker parent) scope
    }
    else if (worker.close) {
        worker.close(); // in worker scope
    }
}
/**
 * Creates JSON-RPC2 message transports for the Web Worker message communication interface.
 *
 * @param worker The Worker to communicate with (e.g., created with `new Worker(...)`), or the global scope (i.e.,
 *               `self`) if the current execution context is in a Worker. Defaults to the global scope.
 */
export function createWebWorkerMessageTransports(worker = globalWorkerScope()) {
    return {
        reader: new WebWorkerMessageReader(worker),
        writer: new WebWorkerMessageWriter(worker),
    };
}
function globalWorkerScope() {
    const worker = global;
    // tslint:disable-next-line no-unbound-method
    if (!worker.postMessage || 'document' in worker) {
        throw new Error('global scope is not a Worker');
    }
    return worker;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViV29ya2VyLmpzIiwic291cmNlUm9vdCI6InNyYy8iLCJzb3VyY2VzIjpbInByb3RvY29sL2pzb25ycGMyL3RyYW5zcG9ydHMvd2ViV29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxxQkFBcUIsRUFBOEMsTUFBTSxjQUFjLENBQUE7QUF1QnZILE1BQU0sc0JBQXVCLFNBQVEscUJBQXFCO0lBSXRELFlBQW9CLE1BQWM7UUFDOUIsS0FBSyxFQUFFLENBQUE7UUFEUyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBSDFCLFlBQU8sR0FBYyxFQUFFLENBQUE7UUFDdkIsYUFBUSxHQUF3QixJQUFJLENBQUE7UUFLeEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxDQUFDLENBQWUsRUFBRSxFQUFFO1lBQ25ELElBQUk7Z0JBQ0EsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQTthQUN6QjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNWLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUE7YUFDdEI7UUFDTCxDQUFDLENBQUMsQ0FBQTtRQUNGLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNuQixlQUFlLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDdkIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBQ3BCLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVPLGNBQWMsQ0FBQyxDQUFlO1FBQ2xDLE1BQU0sT0FBTyxHQUFZLENBQUMsQ0FBQyxJQUFJLENBQUE7UUFDL0IsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUN6QjthQUFNO1lBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7U0FDN0I7SUFDTCxDQUFDO0lBRU0sTUFBTSxDQUFDLFFBQXNCO1FBQ2hDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQTtTQUM3QztRQUNELElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFBO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzlCLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRyxDQUFDLENBQUE7U0FDaEM7SUFDTCxDQUFDO0lBRU0sV0FBVztRQUNkLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQTtRQUNuQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQTtRQUNwQixlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ2hDLENBQUM7Q0FDSjtBQUVELE1BQU0sc0JBQXVCLFNBQVEscUJBQXFCO0lBR3RELFlBQW9CLE1BQWM7UUFDOUIsS0FBSyxFQUFFLENBQUE7UUFEUyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBRjFCLGVBQVUsR0FBRyxDQUFDLENBQUE7SUFJdEIsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFnQjtRQUN6QixJQUFJO1lBQ0EsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUE7U0FDbkM7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNaLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtTQUNwRDtJQUNMLENBQUM7SUFFTSxXQUFXO1FBQ2QsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ25CLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDaEMsQ0FBQztDQUNKO0FBRUQsU0FBUyxlQUFlLENBQUMsTUFBYztJQUNuQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDbEIsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBLENBQUMsa0NBQWtDO0tBQ3hEO1NBQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFO1FBQ3JCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQSxDQUFDLGtCQUFrQjtLQUNwQztBQUNMLENBQUM7QUFFRDs7Ozs7R0FLRztBQUNILE1BQU0sVUFBVSxnQ0FBZ0MsQ0FBQyxTQUFpQixpQkFBaUIsRUFBRTtJQUNqRixPQUFPO1FBQ0gsTUFBTSxFQUFFLElBQUksc0JBQXNCLENBQUMsTUFBTSxDQUFDO1FBQzFDLE1BQU0sRUFBRSxJQUFJLHNCQUFzQixDQUFDLE1BQU0sQ0FBQztLQUM3QyxDQUFBO0FBQ0wsQ0FBQztBQUVELFNBQVMsaUJBQWlCO0lBQ3RCLE1BQU0sTUFBTSxHQUFXLE1BQWEsQ0FBQTtJQUNwQyw2Q0FBNkM7SUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLElBQUksVUFBVSxJQUFJLE1BQU0sRUFBRTtRQUM3QyxNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUE7S0FDbEQ7SUFDRCxPQUFPLE1BQU0sQ0FBQTtBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWVzc2FnZVRyYW5zcG9ydHMgfSBmcm9tICcuLi9jb25uZWN0aW9uJ1xuaW1wb3J0IHsgTWVzc2FnZSB9IGZyb20gJy4uL21lc3NhZ2VzJ1xuaW1wb3J0IHsgQWJzdHJhY3RNZXNzYWdlUmVhZGVyLCBBYnN0cmFjdE1lc3NhZ2VXcml0ZXIsIERhdGFDYWxsYmFjaywgTWVzc2FnZVJlYWRlciwgTWVzc2FnZVdyaXRlciB9IGZyb20gJy4uL3RyYW5zcG9ydCdcblxuLy8gVE9ETzogdXNlIHRyYW5zZmVyYWJsZSBvYmplY3RzIGluIHBvc3RNZXNzYWdlIGZvciBwZXJmXG5cbi8vIENvcGllZCBzdWJzZXQgb2YgV29ya2VyIGZyb20gdGhlIFR5cGVTY3JpcHQgXCJkb21cIi9cIndlYndvcmtlclwiIGNvcmUgbGlicmFyaWVzIHRvIGF2b2lkIG5lZWRpbmcgdG8gYWRkIHRob3NlIGxpYnNcbi8vIHRvIHRzY29uZmlnLmpzb24uXG5pbnRlcmZhY2UgTWVzc2FnZUV2ZW50IHtcbiAgICBkYXRhOiBhbnlcbn1cbmludGVyZmFjZSBXb3JrZXJFdmVudE1hcCB7XG4gICAgZXJyb3I6IGFueVxuICAgIG1lc3NhZ2U6IE1lc3NhZ2VFdmVudFxufVxuaW50ZXJmYWNlIFdvcmtlciB7XG4gICAgcG9zdE1lc3NhZ2UobWVzc2FnZTogYW55KTogdm9pZFxuICAgIGFkZEV2ZW50TGlzdGVuZXI8SyBleHRlbmRzIGtleW9mIFdvcmtlckV2ZW50TWFwPihcbiAgICAgICAgdHlwZTogSyxcbiAgICAgICAgbGlzdGVuZXI6ICh0aGlzOiBXb3JrZXIsIGV2OiBXb3JrZXJFdmVudE1hcFtLXSkgPT4gYW55XG4gICAgKTogdm9pZFxuICAgIGNsb3NlPygpOiB2b2lkXG4gICAgdGVybWluYXRlPygpOiB2b2lkXG59XG5cbmNsYXNzIFdlYldvcmtlck1lc3NhZ2VSZWFkZXIgZXh0ZW5kcyBBYnN0cmFjdE1lc3NhZ2VSZWFkZXIgaW1wbGVtZW50cyBNZXNzYWdlUmVhZGVyIHtcbiAgICBwcml2YXRlIHBlbmRpbmc6IE1lc3NhZ2VbXSA9IFtdXG4gICAgcHJpdmF0ZSBjYWxsYmFjazogRGF0YUNhbGxiYWNrIHwgbnVsbCA9IG51bGxcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgd29ya2VyOiBXb3JrZXIpIHtcbiAgICAgICAgc3VwZXIoKVxuXG4gICAgICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGU6IE1lc3NhZ2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NNZXNzYWdlKGUpXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFcnJvcihlcnIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgICAgICB0aGlzLmZpcmVFcnJvcihlcnIpXG4gICAgICAgICAgICB0ZXJtaW5hdGVXb3JrZXIod29ya2VyKVxuICAgICAgICAgICAgdGhpcy5maXJlQ2xvc2UoKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc01lc3NhZ2UoZTogTWVzc2FnZUV2ZW50KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2U6IE1lc3NhZ2UgPSBlLmRhdGFcbiAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sobWVzc2FnZSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucGVuZGluZy5wdXNoKG1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbGlzdGVuKGNhbGxiYWNrOiBEYXRhQ2FsbGJhY2spOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignY2FsbGJhY2sgaXMgYWxyZWFkeSBzZXQnKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFja1xuICAgICAgICB3aGlsZSAodGhpcy5wZW5kaW5nLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgY2FsbGJhY2sodGhpcy5wZW5kaW5nLnBvcCgpISlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB1bnN1YnNjcmliZSgpOiB2b2lkIHtcbiAgICAgICAgc3VwZXIudW5zdWJzY3JpYmUoKVxuICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbFxuICAgICAgICB0ZXJtaW5hdGVXb3JrZXIodGhpcy53b3JrZXIpXG4gICAgfVxufVxuXG5jbGFzcyBXZWJXb3JrZXJNZXNzYWdlV3JpdGVyIGV4dGVuZHMgQWJzdHJhY3RNZXNzYWdlV3JpdGVyIGltcGxlbWVudHMgTWVzc2FnZVdyaXRlciB7XG4gICAgcHJpdmF0ZSBlcnJvckNvdW50ID0gMFxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB3b3JrZXI6IFdvcmtlcikge1xuICAgICAgICBzdXBlcigpXG4gICAgfVxuXG4gICAgcHVibGljIHdyaXRlKG1lc3NhZ2U6IE1lc3NhZ2UpOiB2b2lkIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMud29ya2VyLnBvc3RNZXNzYWdlKG1lc3NhZ2UpXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmZpcmVFcnJvcihlcnJvciwgbWVzc2FnZSwgKyt0aGlzLmVycm9yQ291bnQpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgdW5zdWJzY3JpYmUoKTogdm9pZCB7XG4gICAgICAgIHN1cGVyLnVuc3Vic2NyaWJlKClcbiAgICAgICAgdGVybWluYXRlV29ya2VyKHRoaXMud29ya2VyKVxuICAgIH1cbn1cblxuZnVuY3Rpb24gdGVybWluYXRlV29ya2VyKHdvcmtlcjogV29ya2VyKTogdm9pZCB7XG4gICAgaWYgKHdvcmtlci50ZXJtaW5hdGUpIHtcbiAgICAgICAgd29ya2VyLnRlcm1pbmF0ZSgpIC8vIGluIHdpbmRvdyAod29ya2VyIHBhcmVudCkgc2NvcGVcbiAgICB9IGVsc2UgaWYgKHdvcmtlci5jbG9zZSkge1xuICAgICAgICB3b3JrZXIuY2xvc2UoKSAvLyBpbiB3b3JrZXIgc2NvcGVcbiAgICB9XG59XG5cbi8qKlxuICogQ3JlYXRlcyBKU09OLVJQQzIgbWVzc2FnZSB0cmFuc3BvcnRzIGZvciB0aGUgV2ViIFdvcmtlciBtZXNzYWdlIGNvbW11bmljYXRpb24gaW50ZXJmYWNlLlxuICpcbiAqIEBwYXJhbSB3b3JrZXIgVGhlIFdvcmtlciB0byBjb21tdW5pY2F0ZSB3aXRoIChlLmcuLCBjcmVhdGVkIHdpdGggYG5ldyBXb3JrZXIoLi4uKWApLCBvciB0aGUgZ2xvYmFsIHNjb3BlIChpLmUuLFxuICogICAgICAgICAgICAgICBgc2VsZmApIGlmIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBjb250ZXh0IGlzIGluIGEgV29ya2VyLiBEZWZhdWx0cyB0byB0aGUgZ2xvYmFsIHNjb3BlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlV2ViV29ya2VyTWVzc2FnZVRyYW5zcG9ydHMod29ya2VyOiBXb3JrZXIgPSBnbG9iYWxXb3JrZXJTY29wZSgpKTogTWVzc2FnZVRyYW5zcG9ydHMge1xuICAgIHJldHVybiB7XG4gICAgICAgIHJlYWRlcjogbmV3IFdlYldvcmtlck1lc3NhZ2VSZWFkZXIod29ya2VyKSxcbiAgICAgICAgd3JpdGVyOiBuZXcgV2ViV29ya2VyTWVzc2FnZVdyaXRlcih3b3JrZXIpLFxuICAgIH1cbn1cblxuZnVuY3Rpb24gZ2xvYmFsV29ya2VyU2NvcGUoKTogV29ya2VyIHtcbiAgICBjb25zdCB3b3JrZXI6IFdvcmtlciA9IGdsb2JhbCBhcyBhbnlcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5ib3VuZC1tZXRob2RcbiAgICBpZiAoIXdvcmtlci5wb3N0TWVzc2FnZSB8fCAnZG9jdW1lbnQnIGluIHdvcmtlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2dsb2JhbCBzY29wZSBpcyBub3QgYSBXb3JrZXInKVxuICAgIH1cbiAgICByZXR1cm4gd29ya2VyXG59XG4iXX0=