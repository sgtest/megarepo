# compare-helm

This is a utility with a very specific, and possibly short-lived, use-case. It
prints a diff of appliance golden fixtures with resources from the templated
Sourcegraph helm chart. "Appliance golden fixtures" are lists of yaml-serialized
resources generated by the appliance (an in-development Kubernetes operator for
Sourcegraph) in response to certain configuration inputs.

## Usage

Example usage:

```
go run ./internal/appliance/dev/compare-helm \
  -component blobstore \
  -golden-file internal/appliance/testdata/golden-fixtures/blobstore/default.yaml
```

Flags:

- `component`: selects a subset of helm-templated resources for comparison.
  Specifically, the "app.kubernetes.io/component" label is used. This appears to
  correspond 1:1 with Sourcegraph services.
- `golden-file`: path to a golden appliance fixture in this repo.
- `helm-template-extra-args`: Optional extra arguments to pass to `helm
template`. Useful for comparing helm value permutations to different golden
  fixtures derived from different config inputs. Example: "--set
  repoUpdater.serviceAccount.create=true".
- `deploy-sourcegraph-helm-path`: path to a checkout of deploy-sourcegraph-helm.
  This is needed unless you are running this command from the root of this repo,
  and deploy-sourcegraph-helm is a sibling directory of your working directory.
- `no-color`: optional, but needed if your version of `diff` doesn't support the
  `--color=auto` option. GNU diff supports this, and can be installed on Mac
  with `brew install diffutils`.

## Interpreting the output

Negative (red) diff is text that was output by helm but not by the golden file,
and green (positive) diff is text that was output by the golden file but not by
helm.

In order to assist in figuring out which resource diff hunks correspond to, `#
<helm|golden> $kind/$name` is printed at the top of each document. Documents are
separated by the standard yaml multi-doc separator `---`.

Resources that appear entirely in red are output by helm but not by the
appliance, and vice-versa for resources that appear entirely in green.

The order of resources in golden fixtures, and the order of keys in a given yaml
document, shouldn't matter. This utility normalizes yaml documents (by
unmarhsalling and re-marshalling), and also sorts the golden fixture into the
same order as the helm output (by `{kind, metadata.name}`).
