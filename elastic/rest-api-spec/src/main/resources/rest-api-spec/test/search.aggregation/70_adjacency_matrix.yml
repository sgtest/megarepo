setup:
  - do:
      indices.create:
          index: test
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              test:
                properties:
                  num:
                    type: integer

  - do:
        index:
          index: test
          type: test
          id: 1
          body: { "num": [1, 2] }

  - do:
      index:
        index: test
        type: test
        id: 2
        body: { "num": [2, 3] }

  - do:
      index:
        index: test
        type: test
        id: 3
        body: { "num": [3, 4] }

  - do:
      indices.refresh: {}


---
"Filters intersections":

  - skip:
      version: " - 5.2.99"
      reason:  Adjacency Matrix is a 5.3.0 feature
      
  - do:
      search:
        body: { "size": 0, "aggs": { "conns": { "adjacency_matrix": {  "filters": { "1": { "term": { "num": 1 } }, "2": { "term": { "num": 2 } }, "4": { "term": { "num": 4 } } } } } } }

  - match: { hits.total: 3 }

  - length: { aggregations.conns.buckets: 4 }

  - match: { aggregations.conns.buckets.0.doc_count: 1 }
  - match: { aggregations.conns.buckets.0.key: "1" }

  - match: { aggregations.conns.buckets.1.doc_count: 1 }
  - match: { aggregations.conns.buckets.1.key: "1&2" }

  - match: { aggregations.conns.buckets.2.doc_count: 2 }
  - match: { aggregations.conns.buckets.2.key: "2" }

  - match: { aggregations.conns.buckets.3.doc_count: 1 }
  - match: { aggregations.conns.buckets.3.key: "4" }

