---
setup:
  - do:
      cluster.health:
          wait_for_status: yellow

---
"Test Basic Policy CRUD":
  - do:
      catch: missing
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

  - do:
      catch: missing
      ilm.delete_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

  - do:
      acknowlege: true
      ilm.put_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
        body: |
           {
             "policy": {
               "phases": {
                 "warm": {
                   "after": "10s",
                   "actions": {
                     "forcemerge": {
                       "max_num_segments": 10000
                     }
                   }
                 },
                 "delete": {
                   "after": "30s",
                   "actions": {
                     "delete": {}
                   }
                 }
               }
             }
           }

  - do:
      acknowledge: true
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
  - match: { my_timeseries_lifecycle.version: 1 }
  - is_true: my_timeseries_lifecycle.modified_date
  - match: { my_timeseries_lifecycle.policy.phases.warm.after: "10s" }
  - match: { my_timeseries_lifecycle.policy.phases.delete.after: "30s" }

  - do:
      acknowledge: true
      ilm.delete_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

  - do:
      catch: missing
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

---
"Test Policy Update":
  - do:
      acknowlege: true
      ilm.put_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
        body: |
           {
             "policy": {
               "phases": {
                 "warm": {
                   "after": "10s",
                   "actions": {
                     "forcemerge": {
                       "max_num_segments": 10000
                     }
                   }
                 },
                 "delete": {
                   "after": "30s",
                   "actions": {
                     "delete": {}
                   }
                 }
               }
             }
           }

  - do:
      acknowledge: true
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
  - match: { my_timeseries_lifecycle.version: 1 }
  - is_true: my_timeseries_lifecycle.modified_date
  - match: { my_timeseries_lifecycle.policy.phases.warm.after: "10s" }
  - match: { my_timeseries_lifecycle.policy.phases.delete.after: "30s" }


  - do:
      indices.create:
        index: my_index
        body:
          settings:
            index.lifecycle.name: "my_moveable_timeseries_lifecycle"

  - do:
      indices.create:
        index: my_index2
        body:
          settings:
            index.lifecycle.name: "my_moveable_timeseries_lifecycle"
  
  - do:
      acknowlege: true
      ilm.put_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
        body: |
           {
             "policy": {
               "phases": {
                 "warm": {
                   "after": "300s",
                   "actions": {
                     "forcemerge": {
                       "max_num_segments": 10000
                     }
                   }
                 },
                 "delete": {
                   "after": "600s",
                   "actions": {
                     "delete": {}
                   }
                 }
               }
             }
           }

  - do:
      acknowledge: true
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
  - match: { my_timeseries_lifecycle.version: 2 }
  - is_true: my_timeseries_lifecycle.modified_date
  - match: { my_timeseries_lifecycle.policy.phases.warm.after: "300s" }
  - match: { my_timeseries_lifecycle.policy.phases.delete.after: "600s" }

  - do:
      acknowledge: true
      indices.delete:
        index: my_index
  - do:
      acknowledge: true
      indices.delete:
        index: my_index2

  - do:
      acknowledge: true
      ilm.delete_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

  - do:
      catch: missing
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

---
"Test Undeletable Policy In Use":
  - do:
      acknowlege: true
      ilm.put_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
        body: |
           {
             "policy": {
               "phases": {
                 "warm": {
                   "after": "10s",
                   "actions": {
                     "forcemerge": {
                       "max_num_segments": 10000
                     }
                   }
                 },
                 "delete": {
                   "after": "30s",
                   "actions": {
                     "delete": {}
                   }
                 }
               }
             }
           }

  - do:
      acknowledge: true
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
  - match: { my_timeseries_lifecycle.policy.phases.warm.after: "10s" }
  - match: { my_timeseries_lifecycle.policy.phases.delete.after: "30s" }

  - do:
      indices.create:
        index: my_timeseries_index
        body:
          settings:
            index.lifecycle.name: "my_timeseries_lifecycle"

  - do:
      catch: bad_request
      ilm.delete_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
  - match: { error.root_cause.0.type: "illegal_argument_exception" }
  - match: { error.root_cause.0.reason: "Cannot delete policy [my_timeseries_lifecycle]. It is being used by at least one index [my_timeseries_index]" }

  - do:
      ilm.remove_policy:
        index: my_timeseries_index

  - do:
      acknowledge: true
      ilm.delete_lifecycle:
        lifecycle: "my_timeseries_lifecycle"

  - do:
      catch: missing
      ilm.get_lifecycle:
        lifecycle: "my_timeseries_lifecycle"
