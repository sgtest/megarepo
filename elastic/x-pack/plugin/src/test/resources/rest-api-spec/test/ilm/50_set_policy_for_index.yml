---
setup:
  - do:
      cluster.health:
          wait_for_status: yellow
  - do:
      acknowlege: true
      ilm.put_lifecycle:
        lifecycle: "my_moveable_timeseries_lifecycle"
        body: |
           {
             "policy": {
               "phases": {
                 "warm": {
                   "after": "1000s",
                   "actions": {
                     "forcemerge": {
                       "max_num_segments": 10000
                     }
                   }
                 },
                 "hot": {
                   "after": "1000s",
                   "actions": { }
                 }
               }
             }
           }

  - do:
      acknowledge: true
      ilm.get_lifecycle:
        lifecycle: "my_moveable_timeseries_lifecycle"
        
  - do:
      acknowlege: true
      ilm.put_lifecycle:
        lifecycle: "my_alternative_timeseries_lifecycle"
        body: |
           {
             "policy": {
               "phases": {
                 "warm": {
                   "after": "1000s",
                   "actions": {
                     "forcemerge": {
                       "max_num_segments": 10000
                     }
                   }
                 },
                 "hot": {
                   "after": "1000s",
                   "actions": { }
                 }
               }
             }
           }

  - do:
      acknowledge: true
      ilm.get_lifecycle:
        lifecycle: "my_alternative_timeseries_lifecycle"

  - do:
      indices.create:
        index: my_index
        body:
          settings:
            index.lifecycle.name: "my_moveable_timeseries_lifecycle"

  - do:
      indices.create:
        index: my_index2
        body:
          settings:
            index.lifecycle.name: "my_moveable_timeseries_lifecycle"

  - do:
      indices.create:
        index: another_index
        body:
          settings:
            index.lifecycle.name: "my_moveable_timeseries_lifecycle"

  - do:
      indices.create:
        index: unmanaged_index
        body:
          settings: {}

  - do:
      indices.create:
        index: my_index_no_policy

---
teardown:

  - do:
      acknowledge: true
      indices.delete:
        index: my_index
  - do:
      acknowledge: true
      indices.delete:
        index: my_index2
  - do:
      acknowledge: true
      indices.delete:
        index: another_index
  - do:
      acknowledge: true
      indices.delete:
        index: unmanaged_index

  - do:
      acknowledge: true
      indices.delete:
        index: my_index_no_policy

  - do:
      acknowledge: true
      ilm.delete_lifecycle:
        lifecycle: "my_moveable_timeseries_lifecycle"

  - do:
      catch: missing
      ilm.get_lifecycle:
        lifecycle: "my_moveable_timeseries_lifecycle"

  - do:
      acknowledge: true
      ilm.delete_lifecycle:
        lifecycle: "my_alternative_timeseries_lifecycle"

  - do:
      catch: missing
      ilm.get_lifecycle:
        lifecycle: "my_alternative_timeseries_lifecycle"

---
"Test Set Policy Single Index":

  - do:
      indices.get_settings:
        index: "another_index"
  
  - match: { another_index.settings.index.lifecycle.name: my_moveable_timeseries_lifecycle }

  - do:
      acknowledge: true
      ilm.set_policy:
        index: "another_index"
        new_policy: my_alternative_timeseries_lifecycle

  - is_false: has_failures
  - length: { failed_indexes: 0 }

  - do:
      indices.get_settings:
        index: "another_index"
  
  - match: { another_index.settings.index.lifecycle.name: my_alternative_timeseries_lifecycle }
  
---
"Test Set Policy Index Pattern":

  - do:
      indices.get_settings:
        index: "my_*"
  
  - match: { my_index.settings.index.lifecycle.name: my_moveable_timeseries_lifecycle }
  - match: { my_index2.settings.index.lifecycle.name: my_moveable_timeseries_lifecycle }

  - do:
      acknowledge: true
      ilm.set_policy:
        index: "my_*"
        new_policy: my_alternative_timeseries_lifecycle

  - is_false: has_failures
  - length: { failed_indexes: 0 }

  - do:
      indices.get_settings:
        index: "my_*"
  
  - match: { my_index.settings.index.lifecycle.name: my_alternative_timeseries_lifecycle }
  - match: { my_index2.settings.index.lifecycle.name: my_alternative_timeseries_lifecycle }
  
---
"Test Set Policy Unmanaged Index":

  - do:
      indices.get_settings:
        index: "unmanaged_index"
  
  - is_false: unmanaged_index.settings.index.lifecycle.name

  - do:
      acknowledge: true
      ilm.set_policy:
        index: "unmanaged_index"
        new_policy: my_alternative_timeseries_lifecycle

  - is_false: has_failures
  - length: { failed_indexes: 0 }

  - do:
      indices.get_settings:
        index: "unmanaged_index"
  
  - match: { unmanaged_index.settings.index.lifecycle.name: my_alternative_timeseries_lifecycle }
  
---
"Test Set Policy Index Does Not Exist":

  - do:
      catch: missing
      ilm.set_policy:
        index: "doesnt_exist"
        new_policy: my_alternative_timeseries_lifecycle
