---
setup:
  - do:
      indices.create:
        index: sensor
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              timestamp:
                type: date
              temperature:
                type: long
              voltage:
                type: double
              node:
                type: keyword
              voltage_percent:
                type: runtime_script
                runtime_type: double
                script:
                  source: |
                    def voltage = doc['voltage'];
                    double[] result = new double[voltage.size()];
                    int i = 0;
                    for (double v : voltage) {
                      result[i++] = v / params.max;
                    }
                    return result;
                  params:
                    max: 5.8
              # Test fetching from _source and the the def -> double[] conversion
              voltage_percent_from_source:
                type: runtime_script
                runtime_type: double
                script:
                  source: |
                    source['voltage'] / params.max
                  params:
                    max: 5.8
              # Test the implicit conversion from double -> double[]
              voltage_percent_returning_double:
                type: runtime_script
                runtime_type: double
                script:
                  source: |
                     ((double) source['voltage']) / 5.8
              # Test the implicit conversion from long -> double[]
              voltage_percent_returning_long:
                type: runtime_script
                runtime_type: double
                script:
                  source: |
                     (long) (doc['voltage_percent_returning_double'].value * 100)
              # Test the implicit conversion from def (secretly a long) -> double[]
              voltage_percent_returning_def_long:
                type: runtime_script
                runtime_type: double
                script:
                  source: |
                     def v = (long) doc['voltage_percent_returning_long'].value;
                     return v;
              # Test fetching many values and the Collection -> double[] conversion
              voltage_sqrts:
                type: runtime_script
                runtime_type: double
                script:
                  source: |
                    List result = new ArrayList();
                    int i = 0;
                    for (double voltage : doc['voltage']) {
                      double v = voltage;
                      while (v > 1.2) {
                        result.add(v);
                        v = Math.sqrt(v);
                      }
                    }
                    return result;

  - do:
      bulk:
        index: sensor
        refresh: true
        body: |
          {"index":{}}
          {"timestamp": 1516729294000, "temperature": 200, "voltage": 5.2, "node": "a"}
          {"index":{}}
          {"timestamp": 1516642894000, "temperature": 201, "voltage": 5.8, "node": "b"}
          {"index":{}}
          {"timestamp": 1516556494000, "temperature": 202, "voltage": 5.1, "node": "a"}
          {"index":{}}
          {"timestamp": 1516470094000, "temperature": 198, "voltage": 5.6, "node": "b"}
          {"index":{}}
          {"timestamp": 1516383694000, "temperature": 200, "voltage": 4.2, "node": "c"}
          {"index":{}}
          {"timestamp": 1516297294000, "temperature": 202, "voltage": 4.0, "node": "c"}

---
"get mapping":
  - do:
      indices.get_mapping:
        index: sensor
  - match: {sensor.mappings.properties.voltage_percent.type: runtime_script }
  - match: {sensor.mappings.properties.voltage_percent.runtime_type: double }
  - match:
      sensor.mappings.properties.voltage_percent.script.source: |
        def voltage = doc['voltage'];
        double[] result = new double[voltage.size()];
        int i = 0;
        for (double v : voltage) {
          result[i++] = v / params.max;
        }
        return result;
  - match: {sensor.mappings.properties.voltage_percent.script.params: {max: 5.8} }
  - match: {sensor.mappings.properties.voltage_percent.script.lang: painless }

---
"docvalue_fields":
  - do:
      search:
        index: sensor
        body:
          sort: timestamp
          docvalue_fields:
            - voltage_percent
            - voltage_percent_from_source
            - voltage_percent_returning_double
            - voltage_percent_returning_long
            - voltage_percent_returning_def_long
            - voltage_sqrts
  - match: {hits.total.value: 6}
  - match: {hits.hits.0.fields.voltage_percent: [0.6896551724137931] }
  - match: {hits.hits.0.fields.voltage_percent_from_source: [0.6896551724137931] }
  - match: {hits.hits.0.fields.voltage_percent_returning_double: [0.6896551724137931] }
  - match: {hits.hits.0.fields.voltage_percent_returning_long: [68.0] }
  - match: {hits.hits.0.fields.voltage_percent_returning_def_long: [68.0] }
  # Scripts that scripts that emit multiple values are supported and their results are sorted
  - match: {hits.hits.0.fields.voltage_sqrts: [1.4142135623730951, 2.0, 4.0] }
  - match: {hits.hits.1.fields.voltage_percent: [0.7241379310344828] }
  - match: {hits.hits.2.fields.voltage_percent: [0.9655172413793103] }
  - match: {hits.hits.3.fields.voltage_percent: [0.8793103448275862] }
  - match: {hits.hits.4.fields.voltage_percent: [1.0] }
  - match: {hits.hits.5.fields.voltage_percent: [0.896551724137931] }

---
"terms agg":
  - do:
      search:
        index: sensor
        body:
          aggs:
            v10:
              terms:
                field: voltage_percent
  - match: {hits.total.value: 6}
  - match: {aggregations.v10.buckets.0.key: 0.6896551724137931}
  - match: {aggregations.v10.buckets.0.doc_count: 1}
  - match: {aggregations.v10.buckets.1.key: 0.7241379310344828}
  - match: {aggregations.v10.buckets.1.doc_count: 1}

---
"range query":
  - do:
      search:
        index: sensor
        body:
          query:
            range:
              voltage_percent:
                lt: .7
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 4.0}

  - do:
      search:
        index: sensor
        body:
          query:
            range:
              voltage_percent:
                gt: 1
  - match: {hits.total.value: 0}

  - do:
      search:
        index: sensor
        body:
          query:
            range:
              voltage_percent:
                gte: 1
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

  - do:
      search:
        index: sensor
        body:
          query:
            range:
              voltage_percent:
                gte: .7
                lte: .8
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 4.2}

---
"term query":
  - do:
      search:
        index: sensor
        body:
          query:
            term:
              voltage_percent: 1.0
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}
